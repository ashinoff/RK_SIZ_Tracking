<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–°–ò–ó ‚Äî –£—á—ë—Ç –∏ –¥–≤–∏–∂–µ–Ω–∏–µ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.3.1/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.3.1/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.26.2/babel.min.js"></script>
<style>
/* ============ RESET & BASE ============ */
*{margin:0;padding:0;box-sizing:border-box}
:root{--primary:#2563eb;--primary-dark:#1d4ed8;--primary-light:#eff6ff;--gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;--gray-500:#6b7280;--gray-700:#374151;--gray-900:#111827;--success:#22c55e;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6;--sidebar-bg:#1e293b;--sidebar-width:240px}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--gray-50);color:var(--gray-900);font-size:14px;line-height:1.5}
a{color:var(--primary);text-decoration:none}
/* ============ LAYOUT ============ */
.app-layout{display:flex;min-height:100vh}
.sidebar{width:var(--sidebar-width);background:var(--sidebar-bg);color:#fff;display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;overflow-y:auto;z-index:100}
.sidebar-header{padding:20px;border-bottom:1px solid rgba(255,255,255,.1)}
.sidebar-header h2{font-size:20px}
.sidebar-user{padding:12px 20px;border-bottom:1px solid rgba(255,255,255,.1);font-size:13px}
.sidebar-user .role{color:rgba(255,255,255,.5);font-size:11px;margin-top:2px}
.sidebar nav{flex:1;padding:8px 0}
.nav-section{color:rgba(255,255,255,.4);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;padding:12px 20px 4px}
.nav-link{display:block;padding:8px 20px;color:rgba(255,255,255,.7);font-size:13px;cursor:pointer;transition:all .15s}
.nav-link:hover{background:rgba(255,255,255,.08);color:#fff}
.nav-link.active{background:rgba(255,255,255,.12);color:#fff;border-right:3px solid var(--primary)}
.sidebar-footer{padding:16px 20px;border-top:1px solid rgba(255,255,255,.1)}
.main-content{margin-left:var(--sidebar-width);flex:1;padding:24px;min-height:100vh}
/* ============ COMPONENTS ============ */
.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:8px}
.page-header h1{font-size:22px;font-weight:700}
.card{background:#fff;border-radius:10px;border:1px solid var(--gray-200);padding:16px;margin-bottom:12px}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.card-header h3{font-size:15px;font-weight:600}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
.stat-card{background:#fff;border-radius:10px;border:1px solid var(--gray-200);padding:16px}
.stat-value{font-size:28px;font-weight:700;color:var(--gray-900)}
.stat-label{font-size:12px;color:var(--gray-500);margin-top:2px}
/* ============ TABLE ============ */
.table-container{overflow-x:auto}
table{width:100%;border-collapse:collapse}
thead th{background:var(--gray-50);color:var(--gray-500);font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.3px;padding:10px 12px;text-align:left;border-bottom:2px solid var(--gray-200);white-space:nowrap}
tbody td{padding:10px 12px;border-bottom:1px solid var(--gray-100);font-size:13px}
tbody tr:hover{background:var(--gray-50)}
/* ============ FORMS ============ */
.form-group{margin-bottom:12px;flex:1}
.form-group label{display:block;font-size:12px;font-weight:600;color:var(--gray-500);margin-bottom:4px}
.form-control{width:100%;padding:8px 12px;border:1px solid var(--gray-300);border-radius:6px;font-size:13px;background:#fff;transition:border-color .15s}
.form-control:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.form-row{display:flex;gap:12px;flex-wrap:wrap}
.form-row .form-group{min-width:150px}
/* ============ BUTTONS ============ */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:6px;font-size:13px;font-weight:500;border:1px solid transparent;cursor:pointer;transition:all .15s;white-space:nowrap}
.btn-primary{background:var(--primary);color:#fff;border-color:var(--primary)}
.btn-primary:hover{background:var(--primary-dark)}
.btn-outline{background:transparent;border-color:var(--gray-300);color:var(--gray-700)}
.btn-outline:hover{background:var(--gray-50);border-color:var(--gray-500)}
.btn-sm{padding:4px 10px;font-size:12px}
.btn-danger{background:var(--danger);color:#fff;border-color:var(--danger)}
/* ============ BADGES ============ */
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;background:var(--gray-100);color:var(--gray-700)}
.badge-success{background:#dcfce7;color:#166534}
.badge-warning{background:#fef3c7;color:#92400e}
.badge-danger{background:#fee2e2;color:#991b1b}
.badge-info{background:#dbeafe;color:#1e40af}
/* ============ TABS ============ */
.tabs{display:flex;border-bottom:2px solid var(--gray-200);margin-bottom:16px;gap:0;overflow-x:auto}
.tab{padding:10px 16px;font-size:13px;font-weight:500;color:var(--gray-500);cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;margin-bottom:-2px;white-space:nowrap}
.tab.active{color:var(--primary);border-bottom-color:var(--primary)}
.tab:hover{color:var(--gray-900)}
/* ============ MODAL ============ */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px}
.modal{background:#fff;border-radius:12px;width:100%;max-width:540px;max-height:90vh;display:flex;flex-direction:column}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--gray-200)}
.modal-header h2{font-size:16px;font-weight:600}
.modal-body{padding:20px;overflow-y:auto;flex:1}
.modal-footer{padding:12px 20px;border-top:1px solid var(--gray-200);display:flex;justify-content:flex-end;gap:8px}
/* ============ MISC ============ */
.text-muted{color:var(--gray-500)}
.empty-state{text-align:center;padding:40px 20px;color:var(--gray-500)}
.empty-state .icon{font-size:40px;margin-bottom:8px}
.loading{display:flex;justify-content:center;align-items:center;min-height:200px;color:var(--gray-500);font-size:15px}
.login-page{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#1e293b 0%,#334155 100%)}
.login-card{background:#fff;padding:40px;border-radius:16px;width:100%;max-width:380px;box-shadow:0 25px 50px rgba(0,0,0,.25)}
.login-card h1{text-align:center;margin-bottom:24px;font-size:24px}
.login-error{background:#fee2e2;color:#991b1b;padding:10px;border-radius:6px;margin-bottom:12px;font-size:13px}
.flex{display:flex}.gap-2{gap:8px}.gap-3{gap:12px}
.tree-branch{margin-left:32px;border-left:2px solid var(--gray-200);padding-left:16px;margin-top:8px}
.tree-item{display:flex;align-items:center;justify-content:space-between;padding:6px 0;cursor:pointer}
.tree-item:hover{background:var(--gray-50);border-radius:6px}
details summary{cursor:pointer;color:var(--primary);font-size:13px}
pre{font-size:11px;max-width:400px;overflow:auto;background:var(--gray-50);padding:8px;border-radius:4px;margin-top:4px}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, createContext, useContext } = React;

// ============ API ============
const API = {
  token: localStorage.getItem('siz_token'),
  async req(method, url, data) {
    const opts = {
      method, headers: { 'Content-Type': 'application/json' },
    };
    if (this.token) opts.headers['Authorization'] = `Bearer ${this.token}`;
    if (data) opts.body = JSON.stringify(data);
    const res = await fetch(`/api${url}`, opts);
    if (res.status === 401) { this.token = null; localStorage.removeItem('siz_token'); localStorage.removeItem('siz_user'); window.location.hash = '#/login'; throw new Error('Unauthorized'); }
    const json = await res.json();
    if (!res.ok) throw { response: { data: json } };
    return json;
  },
  get(u) { return this.req('GET', u); },
  post(u, d) { return this.req('POST', u, d); },
  put(u, d) { return this.req('PUT', u, d); },
  del(u) { return this.req('DELETE', u); },
  setToken(t) { this.token = t; localStorage.setItem('siz_token', t); },
  clearToken() { this.token = null; localStorage.removeItem('siz_token'); localStorage.removeItem('siz_user'); }
};

// ============ AUTH CONTEXT ============
const AuthCtx = createContext(null);
const useAuth = () => useContext(AuthCtx);

const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(() => {
    try { return JSON.parse(localStorage.getItem('siz_user')); } catch { return null; }
  });
  const login = async (username, password) => {
    const data = await API.post('/auth/login', { username, password });
    API.setToken(data.token);
    localStorage.setItem('siz_user', JSON.stringify(data.user));
    setUser(data.user);
  };
  const logout = () => { API.clearToken(); setUser(null); };
  const hasPerm = (p) => user?.general_permissions?.[p] === true;
  const isLevel = (levels) => levels.includes(user?.role_level);
  return <AuthCtx.Provider value={{ user, login, logout, hasPerm, isLevel }}>{children}</AuthCtx.Provider>;
};

// ============ ROUTER (hash-based) ============
const useRoute = () => {
  const [hash, setHash] = useState(window.location.hash || '#/');
  useEffect(() => {
    const handler = () => setHash(window.location.hash || '#/');
    window.addEventListener('hashchange', handler);
    return () => window.removeEventListener('hashchange', handler);
  }, []);
  const path = hash.replace('#', '') || '/';
  const navigate = (to) => { window.location.hash = to; };
  return { path, navigate };
};

// ============ MODAL ============
const Modal = ({ isOpen, onClose, title, footer, children }) => {
  if (!isOpen) return null;
  return <div className="modal-overlay" onClick={onClose}>
    <div className="modal" onClick={e => e.stopPropagation()}>
      <div className="modal-header"><h2>{title}</h2><button className="btn btn-outline btn-sm" onClick={onClose}>‚úï</button></div>
      <div className="modal-body">{children}</div>
      {footer && <div className="modal-footer">{footer}</div>}
    </div>
  </div>;
};

// ============ HELPERS ============
const fio = e => [e?.last_name, e?.first_name, e?.middle_name].filter(Boolean).join(' ');
const fmtDate = d => d ? new Date(d).toLocaleDateString('ru-RU') : '‚Äî';
const fmtDateTime = d => d ? new Date(d).toLocaleString('ru-RU') : '‚Äî';
const txLabel = t => ({ issue:'–í—ã–¥–∞—á–∞', return:'–í–æ–∑–≤—Ä–∞—Ç', write_off:'–°–ø–∏—Å–∞–Ω–∏–µ', exchange:'–û–±–º–µ–Ω' }[t] || t);
const txBadge = t => ({ issue:'badge badge-success', return:'badge badge-info', write_off:'badge badge-danger', exchange:'badge badge-warning' }[t] || 'badge');
const isExpired = d => d && new Date(d) < new Date();

// ============ LOGIN PAGE ============
const LoginPage = () => {
  const { login } = useAuth();
  const [form, setForm] = useState({ username: '', password: '' });
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const handleSubmit = async () => {
    setLoading(true); setError('');
    try { await login(form.username, form.password); window.location.hash = '#/'; }
    catch (e) { setError(e?.response?.data?.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞'); }
    setLoading(false);
  };
  return <div className="login-page">
    <div className="login-card">
      <div style={{textAlign:'center',fontSize:48,marginBottom:8}}>ü¶∫</div>
      <h1>–£—á—ë—Ç –°–ò–ó</h1>
      {error && <div className="login-error">{error}</div>}
      <div className="form-group"><label>–õ–æ–≥–∏–Ω</label>
        <input className="form-control" value={form.username} onChange={e=>setForm({...form,username:e.target.value})} onKeyDown={e=>e.key==='Enter'&&handleSubmit()} /></div>
      <div className="form-group"><label>–ü–∞—Ä–æ–ª—å</label>
        <input className="form-control" type="password" value={form.password} onChange={e=>setForm({...form,password:e.target.value})} onKeyDown={e=>e.key==='Enter'&&handleSubmit()} /></div>
      <button className="btn btn-primary" style={{width:'100%',marginTop:8}} onClick={handleSubmit} disabled={loading}>{loading ? '–í—Ö–æ–¥...' : '–í–æ–π—Ç–∏'}</button>
    </div>
  </div>;
};

// ============ DASHBOARD ============
const Dashboard = () => {
  const [stats, setStats] = useState({ employees:[], transactions:[], summary:[] });
  const [loading, setLoading] = useState(true);
  useEffect(() => {
    Promise.all([API.get('/employees'), API.get('/transactions?limit=10'), API.get('/transactions/reports/summary')])
      .then(([e,t,s]) => setStats({ employees:e, transactions:t, summary:s }))
      .catch(console.error).finally(() => setLoading(false));
  }, []);
  if (loading) return <div className="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;
  return <div>
    <div className="page-header"><h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1></div>
    <div className="stats-grid" style={{marginBottom:16}}>
      <div className="stat-card"><div className="stat-value">{stats.employees.length}</div><div className="stat-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div></div>
      <div className="stat-card"><div className="stat-value">{stats.transactions.length}</div><div className="stat-label">–ü–æ—Å–ª–µ–¥–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</div></div>
      <div className="stat-card"><div className="stat-value">{stats.summary.length}</div><div className="stat-label">–†–≠–°</div></div>
      <div className="stat-card"><div className="stat-value" style={{color:'var(--danger)'}}>{stats.summary.reduce((a,s)=>a+parseInt(s.expired_count||0),0)}</div><div className="stat-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –°–ò–ó</div></div>
    </div>
    <div className="card"><div className="card-header"><h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h3></div>
      <div className="table-container"><table><thead><tr><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–°–ò–ó</th><th>–ö–æ–ª-–≤–æ</th></tr></thead>
        <tbody>{stats.transactions.length===0 ? <tr><td colSpan="5"><div className="empty-state">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div></td></tr> :
          stats.transactions.map(t => <tr key={t.id}>
            <td>{fmtDate(t.transaction_date)}</td><td><span className={txBadge(t.transaction_type)}>{txLabel(t.transaction_type)}</span></td>
            <td style={{fontWeight:500}}>{fio(t)}</td><td>{t.item_name}</td><td>{t.quantity} {t.unit}</td>
          </tr>)}</tbody></table></div>
    </div>
  </div>;
};

// ============ EMPLOYEES ============
const Employees = ({ navigate }) => {
  const { hasPerm } = useAuth();
  const [data, setData] = useState({ employees:[], positions:[], resUnits:[], enterprises:[] });
  const [filters, setFilters] = useState({ search:'', res_unit_id:'', enterprise_id:'', position_id:'' });
  const [showModal, setShowModal] = useState(false);
  const [form, setForm] = useState({});
  const [loading, setLoading] = useState(true);
  const load = useCallback(() => {
    const p = new URLSearchParams();
    Object.entries(filters).forEach(([k,v]) => { if(v) p.append(k,v); });
    Promise.all([API.get(`/employees?${p}`), API.get('/positions'), API.get('/org/res-units'), API.get('/org/enterprises')])
      .then(([e,pos,r,ent]) => setData({employees:e,positions:pos,resUnits:r,enterprises:ent}))
      .catch(console.error).finally(() => setLoading(false));
  }, [filters]);
  useEffect(() => { load(); }, [load]);
  const save = async () => {
    try {
      if(form.id) await API.put(`/employees/${form.id}`,form); else await API.post('/employees',form);
      setShowModal(false); setForm({}); load();
    } catch(e){ alert(e?.response?.data?.error||'–û—à–∏–±–∫–∞'); }
  };
  if (loading) return <div className="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;
  return <div>
    <div className="page-header"><h1>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ ({data.employees.length})</h1>
      {hasPerm('can_create') && <button className="btn btn-primary" onClick={()=>{setForm({});setShowModal(true)}}>+ –°–æ—Ç—Ä—É–¥–Ω–∏–∫</button>}</div>
    <div className="card" style={{marginBottom:16}}><div className="form-row">
      <div className="form-group" style={{flex:2}}><input className="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û..." value={filters.search} onChange={e=>setFilters({...filters,search:e.target.value})} /></div>
      <div className="form-group"><select className="form-control" value={filters.enterprise_id} onChange={e=>setFilters({...filters,enterprise_id:e.target.value})}><option value="">–í—Å–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è</option>{data.enterprises.map(e=><option key={e.id} value={e.id}>{e.name}</option>)}</select></div>
      <div className="form-group"><select className="form-control" value={filters.res_unit_id} onChange={e=>setFilters({...filters,res_unit_id:e.target.value})}><option value="">–í—Å–µ –†–≠–°</option>{data.resUnits.map(r=><option key={r.id} value={r.id}>{r.name}</option>)}</select></div>
    </div></div>
    <div className="card"><div className="table-container"><table><thead><tr><th>–¢–∞–±. ‚Ññ</th><th>–§–ò–û</th><th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th><th>–†–≠–°</th><th>–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</th><th></th></tr></thead>
      <tbody>{data.employees.length===0 ? <tr><td colSpan="6"><div className="empty-state"><div className="icon">üë•</div>–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div></td></tr> :
        data.employees.map(emp=><tr key={emp.id} onClick={()=>navigate(`/employees/${emp.id}`)} style={{cursor:'pointer'}}>
          <td className="text-muted">{emp.employee_number||'‚Äî'}</td><td style={{fontWeight:500}}>{fio(emp)}</td>
          <td>{emp.position_name||'‚Äî'}</td><td>{emp.res_name||'‚Äî'}</td><td className="text-muted">{emp.enterprise_name||'‚Äî'}</td>
          <td>{hasPerm('can_edit') && <button className="btn btn-outline btn-sm" onClick={e=>{e.stopPropagation();setForm(emp);setShowModal(true)}}>‚úèÔ∏è</button>}</td>
        </tr>)}</tbody></table></div></div>
    <Modal isOpen={showModal} onClose={()=>setShowModal(false)} title={form.id?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å':'–ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫'}
      footer={<><button className="btn btn-outline" onClick={()=>setShowModal(false)}>–û—Ç–º–µ–Ω–∞</button><button className="btn btn-primary" onClick={save}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></>}>
      <div className="form-row">
        <div className="form-group"><label>–§–∞–º–∏–ª–∏—è *</label><input className="form-control" value={form.last_name||''} onChange={e=>setForm({...form,last_name:e.target.value})} /></div>
        <div className="form-group"><label>–ò–º—è *</label><input className="form-control" value={form.first_name||''} onChange={e=>setForm({...form,first_name:e.target.value})} /></div>
        <div className="form-group"><label>–û—Ç—á–µ—Å—Ç–≤–æ</label><input className="form-control" value={form.middle_name||''} onChange={e=>setForm({...form,middle_name:e.target.value})} /></div>
      </div>
      <div className="form-row">
        <div className="form-group"><label>–¢–∞–±–µ–ª—å–Ω—ã–π ‚Ññ</label><input className="form-control" value={form.employee_number||''} onChange={e=>setForm({...form,employee_number:e.target.value})} /></div>
        <div className="form-group"><label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label><select className="form-control" value={form.position_id||''} onChange={e=>setForm({...form,position_id:e.target.value||null})}><option value="">‚Äî</option>{data.positions.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}</select></div>
      </div>
      <div className="form-row">
        <div className="form-group"><label>–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</label><select className="form-control" value={form.enterprise_id||''} onChange={e=>setForm({...form,enterprise_id:e.target.value||null})}><option value="">‚Äî</option>{data.enterprises.map(e=><option key={e.id} value={e.id}>{e.name}</option>)}</select></div>
        <div className="form-group"><label>–†–≠–°</label><select className="form-control" value={form.res_unit_id||''} onChange={e=>setForm({...form,res_unit_id:e.target.value||null})}><option value="">‚Äî</option>{data.resUnits.filter(r=>!form.enterprise_id||r.enterprise_id===form.enterprise_id).map(r=><option key={r.id} value={r.id}>{r.name}</option>)}</select></div>
      </div>
      <div className="form-group"><label>–î–∞—Ç–∞ –ø—Ä–∏—ë–º–∞</label><input className="form-control" type="date" value={form.hire_date||''} onChange={e=>setForm({...form,hire_date:e.target.value})} /></div>
    </Modal>
  </div>;
};

// ============ EMPLOYEE CARD ============
const EmployeeCard = ({ id, navigate }) => {
  const { hasPerm } = useAuth();
  const [emp, setEmp] = useState(null);
  const [items, setItems] = useState([]);
  const [tab, setTab] = useState('balance');
  const [showTx, setShowTx] = useState(false);
  const [txForm, setTxForm] = useState({ transaction_type:'issue', quantity:1 });
  const [loading, setLoading] = useState(true);
  const load = useCallback(() => {
    Promise.all([API.get(`/employees/${id}`), API.get('/siz/items')])
      .then(([e,i]) => { setEmp(e); setItems(i); })
      .catch(e => { console.error(e); if(e?.response?.data?.error) navigate('/employees'); })
      .finally(() => setLoading(false));
  }, [id]);
  useEffect(() => { load(); }, [load]);
  const saveTx = async () => {
    try {
      await API.post('/transactions', { ...txForm, employee_id:id, transaction_date:txForm.transaction_date||new Date().toISOString().split('T')[0] });
      setShowTx(false); setTxForm({transaction_type:'issue',quantity:1}); load();
    } catch(e){ alert(e?.response?.data?.error||'–û—à–∏–±–∫–∞'); }
  };
  if (loading) return <div className="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;
  if (!emp) return <div className="empty-state">–ù–µ –Ω–∞–π–¥–µ–Ω</div>;
  return <div>
    <div className="page-header">
      <div className="flex gap-3" style={{alignItems:'center'}}><button className="btn btn-outline btn-sm" onClick={()=>navigate('/employees')}>‚Üê –ù–∞–∑–∞–¥</button><h1>{fio(emp)}</h1></div>
      {hasPerm('can_create') && <button className="btn btn-primary" onClick={()=>{setTxForm({transaction_type:'issue',quantity:1});setShowTx(true)}}>+ –û–ø–µ—Ä–∞—Ü–∏—è</button>}
    </div>
    <div className="card" style={{marginBottom:16}}>
      <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(180px,1fr))',gap:16}}>
        <div><div className="text-muted" style={{fontSize:12}}>–¢–∞–±–µ–ª—å–Ω—ã–π ‚Ññ</div><div style={{fontWeight:500}}>{emp.employee_number||'‚Äî'}</div></div>
        <div><div className="text-muted" style={{fontSize:12}}>–î–æ–ª–∂–Ω–æ—Å—Ç—å</div><div style={{fontWeight:500}}>{emp.position_name||'‚Äî'}</div></div>
        <div><div className="text-muted" style={{fontSize:12}}>–†–≠–°</div><div style={{fontWeight:500}}>{emp.res_name||'‚Äî'}</div></div>
        <div><div className="text-muted" style={{fontSize:12}}>–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</div><div style={{fontWeight:500}}>{emp.enterprise_name||'‚Äî'}</div></div>
        <div><div className="text-muted" style={{fontSize:12}}>–î–∞—Ç–∞ –ø—Ä–∏—ë–º–∞</div><div style={{fontWeight:500}}>{fmtDate(emp.hire_date)}</div></div>
      </div>
    </div>
    <div className="stats-grid" style={{marginBottom:16}}>
      <div className="stat-card"><div className="stat-value">{emp.balance?.length||0}</div><div className="stat-label">–°–ò–ó –Ω–∞ —Ä—É–∫–∞—Ö</div></div>
      <div className="stat-card"><div className="stat-value">{emp.norms?.length||0}</div><div className="stat-label">–ù–æ—Ä–º –ø–æ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏</div></div>
      <div className="stat-card"><div className="stat-value">{emp.transactions?.length||0}</div><div className="stat-label">–í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π</div></div>
      <div className="stat-card" style={{borderLeft:`3px solid ${emp.balance?.some(b=>isExpired(b.valid_until))?'var(--danger)':'var(--success)'}`}}><div className="stat-value" style={{color:emp.balance?.some(b=>isExpired(b.valid_until))?'var(--danger)':'var(--success)'}}>{emp.balance?.filter(b=>isExpired(b.valid_until)).length||0}</div><div className="stat-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö</div></div>
    </div>
    <div className="tabs">
      <button className={`tab ${tab==='balance'?'active':''}`} onClick={()=>setTab('balance')}>–ù–∞ —Ä—É–∫–∞—Ö ({emp.balance?.length||0})</button>
      <button className={`tab ${tab==='history'?'active':''}`} onClick={()=>setTab('history')}>–ò—Å—Ç–æ—Ä–∏—è ({emp.transactions?.length||0})</button>
      <button className={`tab ${tab==='norms'?'active':''}`} onClick={()=>setTab('norms')}>–ù–æ—Ä–º—ã ({emp.norms?.length||0})</button>
    </div>
    <div className="card">
      {tab==='balance' && <div className="table-container"><table><thead><tr><th>–°–ò–ó</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–ö–æ–ª-–≤–æ</th><th>–ü–æ—Å–ª–µ–¥–Ω—è—è –≤—ã–¥–∞—á–∞</th><th>–°—Ä–æ–∫ –¥–æ</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead>
        <tbody>{!emp.balance?.length ? <tr><td colSpan="6"><div className="empty-state"><div className="icon">üì¶</div>–ù–µ—Ç –°–ò–ó</div></td></tr> :
          emp.balance.map((b,i)=><tr key={i}><td style={{fontWeight:500}}>{b.item_name}</td><td className="text-muted">{b.category_name}</td><td>{b.on_hand} {b.unit}</td><td>{fmtDate(b.last_issued)}</td><td>{fmtDate(b.valid_until)}</td><td>{isExpired(b.valid_until)?<span className="badge badge-danger">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>:<span className="badge badge-success">–î–µ–π—Å—Ç–≤—É–µ—Ç</span>}</td></tr>)}</tbody></table></div>}
      {tab==='history' && <div className="table-container"><table><thead><tr><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–°–ò–ó</th><th>–ö–æ–ª-–≤–æ</th><th>–°—Ä–æ–∫ –¥–æ</th><th>–ö—Ç–æ –≤—ã–¥–∞–ª</th><th>–î–æ–∫—É–º–µ–Ω—Ç</th></tr></thead>
        <tbody>{!emp.transactions?.length ? <tr><td colSpan="7"><div className="empty-state"><div className="icon">üìã</div>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div></td></tr> :
          emp.transactions.map(t=><tr key={t.id}><td>{fmtDate(t.transaction_date)}</td><td><span className={txBadge(t.transaction_type)}>{txLabel(t.transaction_type)}</span></td><td style={{fontWeight:500}}>{t.item_name}</td><td>{t.quantity} {t.unit}</td><td>{fmtDate(t.valid_until)}</td><td className="text-muted">{t.issued_by_name||'‚Äî'}</td><td className="text-muted">{t.document_reference||'‚Äî'}</td></tr>)}</tbody></table></div>}
      {tab==='norms' && <div className="table-container"><table><thead><tr><th>–°–ò–ó</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–ù–æ—Ä–º–∞</th><th>–ü–µ—Ä–∏–æ–¥</th><th>–ù–∞ —Ä—É–∫–∞—Ö</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead>
        <tbody>{!emp.norms?.length ? <tr><td colSpan="6"><div className="empty-state"><div className="icon">üìã</div>–ù–æ—Ä–º—ã –Ω–µ –∑–∞–¥–∞–Ω—ã</div></td></tr> :
          emp.norms.map(n => { const bal = emp.balance?.find(b=>b.item_id===n.siz_item_id); const oh = bal?parseInt(bal.on_hand):0;
            return <tr key={n.id}><td style={{fontWeight:500}}>{n.item_name}</td><td className="text-muted">{n.category_name}</td><td>{n.quantity} {n.unit}</td><td>{n.issue_period_months} –º–µ—Å.</td><td>{oh} {n.unit}</td>
              <td>{oh>=n.quantity?<span className="badge badge-success">–û–±–µ—Å–ø–µ—á–µ–Ω</span>:oh>0?<span className="badge badge-warning">–ß–∞—Å—Ç–∏—á–Ω–æ</span>:<span className="badge badge-danger">–ù–µ—Ç</span>}</td></tr>;
          })}</tbody></table></div>}
    </div>
    <Modal isOpen={showTx} onClose={()=>setShowTx(false)} title="–ù–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è"
      footer={<><button className="btn btn-outline" onClick={()=>setShowTx(false)}>–û—Ç–º–µ–Ω–∞</button><button className="btn btn-primary" onClick={saveTx}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></>}>
      <div className="form-group"><label>–¢–∏–ø</label><select className="form-control" value={txForm.transaction_type} onChange={e=>setTxForm({...txForm,transaction_type:e.target.value})}><option value="issue">–í—ã–¥–∞—á–∞</option><option value="return">–í–æ–∑–≤—Ä–∞—Ç</option><option value="write_off">–°–ø–∏—Å–∞–Ω–∏–µ</option><option value="exchange">–û–±–º–µ–Ω</option></select></div>
      <div className="form-group"><label>–°–ò–ó *</label><select className="form-control" value={txForm.siz_item_id||''} onChange={e=>setTxForm({...txForm,siz_item_id:e.target.value})}><option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>{items.map(i=><option key={i.id} value={i.id}>{i.category_name} ‚Üí {i.name}</option>)}</select></div>
      <div className="form-row"><div className="form-group"><label>–ö–æ–ª-–≤–æ</label><input className="form-control" type="number" min="1" value={txForm.quantity} onChange={e=>setTxForm({...txForm,quantity:parseInt(e.target.value)||1})} /></div>
        <div className="form-group"><label>–î–∞—Ç–∞</label><input className="form-control" type="date" value={txForm.transaction_date||''} onChange={e=>setTxForm({...txForm,transaction_date:e.target.value})} /></div></div>
      {txForm.transaction_type==='issue' && <div className="form-group"><label>–°—Ä–æ–∫ –¥–æ</label><input className="form-control" type="date" value={txForm.valid_until||''} onChange={e=>setTxForm({...txForm,valid_until:e.target.value})} /></div>}
      <div className="form-group"><label>–î–æ–∫—É–º–µ–Ω—Ç</label><input className="form-control" value={txForm.document_reference||''} onChange={e=>setTxForm({...txForm,document_reference:e.target.value})} /></div>
      <div className="form-group"><label>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label><input className="form-control" value={txForm.notes||''} onChange={e=>setTxForm({...txForm,notes:e.target.value})} /></div>
    </Modal>
  </div>;
};

// ============ TRANSACTIONS ============
const Transactions = ({ navigate }) => {
  const { hasPerm } = useAuth();
  const [data, setData] = useState({ tx:[], employees:[], items:[] });
  const [filters, setFilters] = useState({ transaction_type:'', date_from:'', date_to:'' });
  const [tab, setTab] = useState('all');
  const [report, setReport] = useState([]);
  const [showModal, setShowModal] = useState(false);
  const [form, setForm] = useState({ transaction_type:'issue', quantity:1 });
  const [loading, setLoading] = useState(true);
  const load = useCallback(() => {
    const p = new URLSearchParams(); Object.entries(filters).forEach(([k,v])=>{if(v)p.append(k,v)});
    Promise.all([API.get(`/transactions?${p}`), API.get('/employees'), API.get('/siz/items')])
      .then(([t,e,i]) => setData({tx:t,employees:e,items:i})).catch(console.error).finally(()=>setLoading(false));
  }, [filters]);
  useEffect(()=>{load();},[load]);
  const loadReport = async type => { setTab(type);
    if(type==='expired') setReport(await API.get('/transactions/reports/expired'));
    if(type==='summary') setReport(await API.get('/transactions/reports/summary'));
  };
  const save = async () => { try {
    await API.post('/transactions',{...form,transaction_date:form.transaction_date||new Date().toISOString().split('T')[0]});
    setShowModal(false); setForm({transaction_type:'issue',quantity:1}); load();
  } catch(e){ alert(e?.response?.data?.error||'–û—à–∏–±–∫–∞'); }};
  if(loading) return <div className="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;
  return <div>
    <div className="page-header"><h1>–î–≤–∏–∂–µ–Ω–∏–µ –°–ò–ó</h1>{hasPerm('can_create')&&<button className="btn btn-primary" onClick={()=>{setForm({transaction_type:'issue',quantity:1});setShowModal(true)}}>+ –û–ø–µ—Ä–∞—Ü–∏—è</button>}</div>
    <div className="tabs">
      <button className={`tab ${tab==='all'?'active':''}`} onClick={()=>setTab('all')}>–í—Å–µ ({data.tx.length})</button>
      <button className={`tab ${tab==='expired'?'active':''}`} onClick={()=>loadReport('expired')}>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</button>
      <button className={`tab ${tab==='summary'?'active':''}`} onClick={()=>loadReport('summary')}>–°–≤–æ–¥–∫–∞ –ø–æ –†–≠–°</button>
    </div>
    {tab==='all' && <><div className="card" style={{marginBottom:16}}><div className="form-row">
      <div className="form-group"><select className="form-control" value={filters.transaction_type} onChange={e=>setFilters({...filters,transaction_type:e.target.value})}><option value="">–í—Å–µ —Ç–∏–ø—ã</option><option value="issue">–í—ã–¥–∞—á–∞</option><option value="return">–í–æ–∑–≤—Ä–∞—Ç</option><option value="write_off">–°–ø–∏—Å–∞–Ω–∏–µ</option></select></div>
      <div className="form-group"><input className="form-control" type="date" value={filters.date_from} onChange={e=>setFilters({...filters,date_from:e.target.value})} /></div>
      <div className="form-group"><input className="form-control" type="date" value={filters.date_to} onChange={e=>setFilters({...filters,date_to:e.target.value})} /></div>
    </div></div>
    <div className="card"><div className="table-container"><table><thead><tr><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–°–ò–ó</th><th>–ö–æ–ª-–≤–æ</th><th>–î–æ–∫—É–º–µ–Ω—Ç</th></tr></thead>
      <tbody>{!data.tx.length?<tr><td colSpan="6"><div className="empty-state"><div className="icon">üìã</div>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div></td></tr>:
        data.tx.map(t=><tr key={t.id}><td>{fmtDate(t.transaction_date)}</td><td><span className={txBadge(t.transaction_type)}>{txLabel(t.transaction_type)}</span></td>
        <td><span style={{cursor:'pointer',color:'var(--primary)',fontWeight:500}} onClick={()=>navigate(`/employees/${t.employee_id}`)}>{fio(t)}</span></td>
        <td>{t.item_name}</td><td>{t.quantity} {t.unit}</td><td className="text-muted">{t.document_reference||'‚Äî'}</td></tr>)}</tbody></table></div></div></>}
    {tab==='expired' && <div className="card"><div className="table-container"><table><thead><tr><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–†–≠–°</th><th>–°–ò–ó</th><th>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω —Å</th></tr></thead>
      <tbody>{!report.length?<tr><td colSpan="4"><div className="empty-state"><div className="icon">‚úÖ</div>–ù–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö</div></td></tr>:
        report.map((r,i)=><tr key={i}><td><span style={{cursor:'pointer',color:'var(--primary)',fontWeight:500}} onClick={()=>navigate(`/employees/${r.employee_id}`)}>{fio(r)}</span></td><td>{r.res_name||'‚Äî'}</td><td>{r.item_name}</td><td><span className="badge badge-danger">{fmtDate(r.valid_until)}</span></td></tr>)}</tbody></table></div></div>}
    {tab==='summary' && <div className="card"><div className="table-container"><table><thead><tr><th>–†–≠–°</th><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</th><th>–í—ã–¥–∞—á</th><th>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</th></tr></thead>
      <tbody>{!report.length?<tr><td colSpan="4"><div className="empty-state">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></td></tr>:
        report.map((r,i)=><tr key={i}><td style={{fontWeight:500}}>{r.res_name}</td><td>{r.employees_count}</td><td>{r.total_issued}</td><td>{parseInt(r.expired_count)>0?<span className="badge badge-danger">{r.expired_count}</span>:<span className="badge badge-success">0</span>}</td></tr>)}</tbody></table></div></div>}
    <Modal isOpen={showModal} onClose={()=>setShowModal(false)} title="–ù–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è"
      footer={<><button className="btn btn-outline" onClick={()=>setShowModal(false)}>–û—Ç–º–µ–Ω–∞</button><button className="btn btn-primary" onClick={save}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></>}>
      <div className="form-group"><label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫ *</label><select className="form-control" value={form.employee_id||''} onChange={e=>setForm({...form,employee_id:e.target.value})}><option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>{data.employees.map(e=><option key={e.id} value={e.id}>{fio(e)} ‚Äî {e.position_name||''}</option>)}</select></div>
      <div className="form-group"><label>–¢–∏–ø</label><select className="form-control" value={form.transaction_type} onChange={e=>setForm({...form,transaction_type:e.target.value})}><option value="issue">–í—ã–¥–∞—á–∞</option><option value="return">–í–æ–∑–≤—Ä–∞—Ç</option><option value="write_off">–°–ø–∏—Å–∞–Ω–∏–µ</option></select></div>
      <div className="form-group"><label>–°–ò–ó *</label><select className="form-control" value={form.siz_item_id||''} onChange={e=>setForm({...form,siz_item_id:e.target.value})}><option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>{data.items.map(i=><option key={i.id} value={i.id}>{i.category_name} ‚Üí {i.name}</option>)}</select></div>
      <div className="form-row"><div className="form-group"><label>–ö–æ–ª-–≤–æ</label><input className="form-control" type="number" min="1" value={form.quantity} onChange={e=>setForm({...form,quantity:parseInt(e.target.value)||1})} /></div>
        <div className="form-group"><label>–î–∞—Ç–∞</label><input className="form-control" type="date" value={form.transaction_date||''} onChange={e=>setForm({...form,transaction_date:e.target.value})} /></div></div>
      {form.transaction_type==='issue'&&<div className="form-group"><label>–°—Ä–æ–∫ –¥–æ</label><input className="form-control" type="date" value={form.valid_until||''} onChange={e=>setForm({...form,valid_until:e.target.value})} /></div>}
      <div className="form-group"><label>–î–æ–∫—É–º–µ–Ω—Ç</label><input className="form-control" value={form.document_reference||''} onChange={e=>setForm({...form,document_reference:e.target.value})} /></div>
    </Modal>
  </div>;
};

// ============ DIRECTORIES ============
const Directories = () => {
  const { hasPerm } = useAuth();
  const [cats, setCats] = useState([]); const [items, setItems] = useState([]);
  const [selectedCat, setSelectedCat] = useState(null);
  const [showModal, setShowModal] = useState(null); const [form, setForm] = useState({});
  const [loading, setLoading] = useState(true);
  const load = useCallback(() => {
    Promise.all([API.get('/siz/categories'), API.get('/siz/items')])
      .then(([c,i])=>{setCats(c);setItems(i);}).catch(console.error).finally(()=>setLoading(false));
  }, []);
  useEffect(()=>{load();},[load]);
  const saveCat = async () => { try { if(form.id) await API.put(`/siz/categories/${form.id}`,form); else await API.post('/siz/categories',form); setShowModal(null);setForm({});load(); } catch(e){alert(e?.response?.data?.error||'–û—à–∏–±–∫–∞');} };
  const saveItem = async () => { try { if(form.id) await API.put(`/siz/items/${form.id}`,form); else await API.post('/siz/items',form); setShowModal(null);setForm({});load(); } catch(e){alert(e?.response?.data?.error||'–û—à–∏–±–∫–∞');} };
  const filtered = selectedCat ? items.filter(i=>i.category_id===selectedCat) : items;
  if(loading) return <div className="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;
  return <div>
    <div className="page-header"><h1>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –°–ò–ó</h1>{hasPerm('can_create')&&<div className="flex gap-2">
      <button className="btn btn-outline" onClick={()=>{setForm({});setShowModal('cat')}}>+ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</button>
      <button className="btn btn-primary" onClick={()=>{setForm({category_id:selectedCat||''});setShowModal('item')}}>+ –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞</button>
    </div>}</div>
    <div className="tabs"><button className={`tab ${!selectedCat?'active':''}`} onClick={()=>setSelectedCat(null)}>–í—Å–µ ({items.length})</button>
      {cats.map(c=><button key={c.id} className={`tab ${selectedCat===c.id?'active':''}`} onClick={()=>setSelectedCat(c.id)}>{c.name} ({items.filter(i=>i.category_id===c.id).length})</button>)}</div>
    <div className="card"><div className="table-container"><table><thead><tr><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ö–æ–¥</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–ï–¥. –∏–∑–º.</th><th>–°—Ä–æ–∫ –Ω–æ—Å–∫–∏ (–º–µ—Å.)</th><th></th></tr></thead>
      <tbody>{!filtered.length?<tr><td colSpan="6"><div className="empty-state"><div className="icon">üìÇ</div>–ù–µ—Ç –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã</div></td></tr>:
        filtered.map(item=><tr key={item.id}><td style={{fontWeight:500}}>{item.name}</td><td className="text-muted">{item.code||'‚Äî'}</td><td>{item.category_name}</td><td>{item.unit}</td><td>{item.wear_period_months||'‚Äî'}</td>
        <td>{hasPerm('can_edit')&&<button className="btn btn-outline btn-sm" onClick={()=>{setForm(item);setShowModal('item')}}>‚úèÔ∏è</button>}</td></tr>)}</tbody></table></div></div>
    <Modal isOpen={showModal==='cat'} onClose={()=>setShowModal(null)} title={form.id?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é':'–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è'}
      footer={<><button className="btn btn-outline" onClick={()=>setShowModal(null)}>–û—Ç–º–µ–Ω–∞</button><button className="btn btn-primary" onClick={saveCat}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></>}>
      <div className="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input className="form-control" value={form.name||''} onChange={e=>setForm({...form,name:e.target.value})} /></div>
      <div className="form-row"><div className="form-group"><label>–ö–æ–¥</label><input className="form-control" value={form.code||''} onChange={e=>setForm({...form,code:e.target.value})} /></div>
        <div className="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><input className="form-control" value={form.description||''} onChange={e=>setForm({...form,description:e.target.value})} /></div></div>
    </Modal>
    <Modal isOpen={showModal==='item'} onClose={()=>setShowModal(null)} title={form.id?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å':'–ù–æ–≤–∞—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞'}
      footer={<><button className="btn btn-outline" onClick={()=>setShowModal(null)}>–û—Ç–º–µ–Ω–∞</button><button className="btn btn-primary" onClick={saveItem}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></>}>
      <div className="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input className="form-control" value={form.name||''} onChange={e=>setForm({...form,name:e.target.value})} /></div>
      <div className="form-row"><div className="form-group"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select className="form-control" value={form.category_id||''} onChange={e=>setForm({...form,category_id:e.target.value})}><option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>{cats.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
        <div className="form-group"><label>–ö–æ–¥</label><input className="form-control" value={form.code||''} onChange={e=>setForm({...form,code:e.target.value})} /></div></div>
      <div className="form-row"><div className="form-group"><label>–ï–¥. –∏–∑–º–µ—Ä–µ–Ω–∏—è</label><input className="form-control" value={form.unit||'—à—Ç'} onChange={e=>setForm({...form,unit:e.target.value})} /></div>
        <div className="form-group"><label>–°—Ä–æ–∫ –Ω–æ—Å–∫–∏ (–º–µ—Å.)</label><input className="form-control" type="number" value={form.wear_period_months||''} onChange={e=>setForm({...form,wear_period_months:parseInt(e.target.value)||null})} /></div></div>
    </Modal>
  </div>;
};

// ============ POSITIONS ============
const Positions = () => {
  const { hasPerm } = useAuth();
  const [positions, setPositions] = useState([]); const [items, setItems] = useState([]);
  const [selected, setSelected] = useState(null); const [norms, setNorms] = useState([]);
  const [showModal, setShowModal] = useState(null); const [form, setForm] = useState({});
  const [loading, setLoading] = useState(true);
  const load = useCallback(() => {
    Promise.all([API.get('/positions'),API.get('/siz/items')]).then(([p,i])=>{setPositions(p);setItems(i);}).catch(console.error).finally(()=>setLoading(false));
  }, []);
  useEffect(()=>{load();},[load]);
  const loadNorms = async id => { setSelected(id); try { setNorms(await API.get(`/positions/${id}/norms`)); } catch(e){console.error(e);} };
  const savePos = async () => { try { if(form.id) await API.put(`/positions/${form.id}`,form); else await API.post('/positions',form); setShowModal(null);setForm({});load(); } catch(e){alert(e?.response?.data?.error||'–û—à–∏–±–∫–∞');} };
  const saveNorm = async () => { try { await API.post(`/positions/${selected}/norms`,form); setShowModal(null);setForm({});loadNorms(selected); } catch(e){alert(e?.response?.data?.error||'–û—à–∏–±–∫–∞');} };
  if(loading) return <div className="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;
  return <div>
    <div className="page-header"><h1>–†–µ–µ—Å—Ç—Ä –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π</h1>{hasPerm('can_create')&&<button className="btn btn-primary" onClick={()=>{setForm({});setShowModal('pos')}}>+ –î–æ–ª–∂–Ω–æ—Å—Ç—å</button>}</div>
    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16}}>
      <div className="card"><div className="card-header"><h3>–î–æ–ª–∂–Ω–æ—Å—Ç–∏</h3></div><div className="table-container"><table><thead><tr><th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th><th>–£—Ä–æ–≤–µ–Ω—å</th><th>–ù–æ—Ä–º—ã</th><th>–°–æ—Ç—Ä.</th><th></th></tr></thead>
        <tbody>{positions.map(p=><tr key={p.id} onClick={()=>loadNorms(p.id)} style={{cursor:'pointer',background:selected===p.id?'var(--primary-light)':undefined}}>
          <td style={{fontWeight:500}}>{p.name}</td><td className="text-muted">{p.level||'‚Äî'}</td><td>{p.norms_count}</td><td>{p.employees_count}</td>
          <td>{hasPerm('can_edit')&&<button className="btn btn-outline btn-sm" onClick={e=>{e.stopPropagation();setForm(p);setShowModal('pos')}}>‚úèÔ∏è</button>}</td>
        </tr>)}{!positions.length&&<tr><td colSpan="5"><div className="empty-state">–ù–µ—Ç –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π</div></td></tr>}</tbody></table></div></div>
      <div className="card"><div className="card-header"><h3>–ù–æ—Ä–º—ã –≤—ã–¥–∞—á–∏ {selected&&`‚Äî ${positions.find(p=>p.id===selected)?.name}`}</h3>
        {selected&&hasPerm('can_create')&&<button className="btn btn-primary btn-sm" onClick={()=>{setForm({position_id:selected});setShowModal('norm')}}>+ –î–æ–±–∞–≤–∏—Ç—å</button>}</div>
        {!selected?<div className="empty-state"><div className="icon">üëà</div>–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—å</div>:
        !norms.length?<div className="empty-state"><div className="icon">üìã</div>–ù–æ—Ä–º—ã –Ω–µ –∑–∞–¥–∞–Ω—ã</div>:
        <div className="table-container"><table><thead><tr><th>–°–ò–ó</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–ö–æ–ª-–≤–æ</th><th>–ü–µ—Ä–∏–æ–¥ (–º–µ—Å.)</th></tr></thead>
          <tbody>{norms.map(n=><tr key={n.id}><td style={{fontWeight:500}}>{n.item_name}</td><td className="text-muted">{n.category_name}</td><td>{n.quantity} {n.unit}</td><td>{n.issue_period_months}</td></tr>)}</tbody></table></div>}
      </div>
    </div>
    <Modal isOpen={showModal==='pos'} onClose={()=>setShowModal(null)} title={form.id?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å':'–ù–æ–≤–∞—è –¥–æ–ª–∂–Ω–æ—Å—Ç—å'}
      footer={<><button className="btn btn-outline" onClick={()=>setShowModal(null)}>–û—Ç–º–µ–Ω–∞</button><button className="btn btn-primary" onClick={savePos}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></>}>
      <div className="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input className="form-control" value={form.name||''} onChange={e=>setForm({...form,name:e.target.value})} /></div>
      <div className="form-row"><div className="form-group"><label>–ö–æ–¥</label><input className="form-control" value={form.code||''} onChange={e=>setForm({...form,code:e.target.value})} /></div>
        <div className="form-group"><label>–£—Ä–æ–≤–µ–Ω—å</label><select className="form-control" value={form.level||''} onChange={e=>setForm({...form,level:e.target.value})}><option value="">‚Äî</option><option value="ia">–ò–ê</option><option value="enterprise">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</option><option value="res">–†–≠–°</option></select></div></div>
    </Modal>
    <Modal isOpen={showModal==='norm'} onClose={()=>setShowModal(null)} title="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ—Ä–º—É"
      footer={<><button className="btn btn-outline" onClick={()=>setShowModal(null)}>–û—Ç–º–µ–Ω–∞</button><button className="btn btn-primary" onClick={saveNorm}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></>}>
      <div className="form-group"><label>–°–ò–ó</label><select className="form-control" value={form.siz_item_id||''} onChange={e=>setForm({...form,siz_item_id:e.target.value})}><option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>{items.map(i=><option key={i.id} value={i.id}>{i.category_name} ‚Üí {i.name}</option>)}</select></div>
      <div className="form-row"><div className="form-group"><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label><input className="form-control" type="number" value={form.quantity||1} onChange={e=>setForm({...form,quantity:parseInt(e.target.value)||1})} /></div>
        <div className="form-group"><label>–ü–µ—Ä–∏–æ–¥ (–º–µ—Å.)</label><input className="form-control" type="number" value={form.issue_period_months||12} onChange={e=>setForm({...form,issue_period_months:parseInt(e.target.value)||12})} /></div></div>
    </Modal>
  </div>;
};

// ============ ORG STRUCTURE ============
const OrgStructure = () => {
  const { hasPerm } = useAuth();
  const [tree, setTree] = useState([]); const [enterprises, setEnterprises] = useState([]);
  const [expanded, setExpanded] = useState({});
  const [showModal, setShowModal] = useState(null); const [form, setForm] = useState({});
  const [loading, setLoading] = useState(true);
  const load = useCallback(() => {
    Promise.all([API.get('/org/tree'),API.get('/org/enterprises')]).then(([t,e])=>{
      setTree(t); setEnterprises(e);
      const ex = {}; t.forEach(o=>{ex[`o-${o.id}`]=true; o.enterprises?.forEach(e=>{ex[`e-${e.id}`]=true});}); setExpanded(ex);
    }).catch(console.error).finally(()=>setLoading(false));
  }, []);
  useEffect(()=>{load();},[load]);
  const toggle = k => setExpanded(p=>({...p,[k]:!p[k]}));
  const save = async () => { try {
    if(showModal==='org'){if(form.id)await API.put(`/org/organizations/${form.id}`,form);else await API.post('/org/organizations',form);}
    if(showModal==='ent'){if(form.id)await API.put(`/org/enterprises/${form.id}`,form);else await API.post('/org/enterprises',form);}
    if(showModal==='res'){if(form.id)await API.put(`/org/res-units/${form.id}`,form);else await API.post('/org/res-units',form);}
    setShowModal(null);setForm({});load();
  } catch(e){alert(e?.response?.data?.error||'–û—à–∏–±–∫–∞');} };
  if(loading) return <div className="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;
  return <div>
    <div className="page-header"><h1>–û—Ä–≥—Å—Ç—Ä—É–∫—Ç—É—Ä–∞</h1>{hasPerm('can_create')&&<div className="flex gap-2">
      <button className="btn btn-outline" onClick={()=>{setForm({});setShowModal('org')}}>+ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</button>
      <button className="btn btn-outline" onClick={()=>{setForm({});setShowModal('ent')}}>+ –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</button>
      <button className="btn btn-primary" onClick={()=>{setForm({});setShowModal('res')}}>+ –†–≠–°</button></div>}</div>
    {!tree.length?<div className="card"><div className="empty-state"><div className="icon">üè¢</div>–ù–µ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</div></div>:
      tree.map(org=><div key={org.id} className="card" style={{marginBottom:12}}>
        <div className="tree-item" onClick={()=>toggle(`o-${org.id}`)}>
          <div className="flex gap-2" style={{alignItems:'center'}}><span>{expanded[`o-${org.id}`]?'‚ñº':'‚ñ∂'}</span><span style={{fontSize:20}}>üèõÔ∏è</span>
            <div><div style={{fontWeight:600,fontSize:16}}>{org.name}</div><div className="text-muted" style={{fontSize:12}}>{org.code||''} ¬∑ {org.enterprises?.length||0} –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π</div></div></div>
          {hasPerm('can_edit')&&<button className="btn btn-outline btn-sm" onClick={e=>{e.stopPropagation();setForm(org);setShowModal('org')}}>‚úèÔ∏è</button>}</div>
        {expanded[`o-${org.id}`]&&org.enterprises?.map(ent=><div key={ent.id} className="tree-branch">
          <div className="tree-item" onClick={()=>toggle(`e-${ent.id}`)}>
            <div className="flex gap-2" style={{alignItems:'center'}}><span style={{fontSize:14}}>{expanded[`e-${ent.id}`]?'‚ñº':'‚ñ∂'}</span><span style={{fontSize:18}}>üè¢</span>
              <div><div style={{fontWeight:500}}>{ent.name}</div><div className="text-muted" style={{fontSize:12}}>{ent.code||''} ¬∑ {ent.res_units?.length||0} –†–≠–°</div></div></div>
            {hasPerm('can_edit')&&<button className="btn btn-outline btn-sm" onClick={e=>{e.stopPropagation();setForm(ent);setShowModal('ent')}}>‚úèÔ∏è</button>}</div>
          {expanded[`e-${ent.id}`]&&ent.res_units?.map(r=><div key={r.id} className="tree-branch">
            <div className="tree-item"><div className="flex gap-2" style={{alignItems:'center'}}><span style={{fontSize:16}}>‚ö°</span>
              <div><div style={{fontWeight:500}}>{r.name}</div><div className="text-muted" style={{fontSize:12}}>{r.code||''}</div></div></div>
            {hasPerm('can_edit')&&<button className="btn btn-outline btn-sm" onClick={()=>{setForm(r);setShowModal('res')}}>‚úèÔ∏è</button>}</div></div>)}
        </div>)}
      </div>)}
    <Modal isOpen={showModal==='org'} onClose={()=>setShowModal(null)} title={form.id?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é':'–ù–æ–≤–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è'}
      footer={<><button className="btn btn-outline" onClick={()=>setShowModal(null)}>–û—Ç–º–µ–Ω–∞</button><button className="btn btn-primary" onClick={save}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></>}>
      <div className="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input className="form-control" value={form.name||''} onChange={e=>setForm({...form,name:e.target.value})} /></div>
      <div className="form-group"><label>–ö–æ–¥</label><input className="form-control" value={form.code||''} onChange={e=>setForm({...form,code:e.target.value})} /></div></Modal>
    <Modal isOpen={showModal==='ent'} onClose={()=>setShowModal(null)} title={form.id?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ':'–ù–æ–≤–æ–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ'}
      footer={<><button className="btn btn-outline" onClick={()=>setShowModal(null)}>–û—Ç–º–µ–Ω–∞</button><button className="btn btn-primary" onClick={save}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></>}>
      <div className="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input className="form-control" value={form.name||''} onChange={e=>setForm({...form,name:e.target.value})} /></div>
      <div className="form-group"><label>–ö–æ–¥</label><input className="form-control" value={form.code||''} onChange={e=>setForm({...form,code:e.target.value})} /></div>
      <div className="form-group"><label>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</label><select className="form-control" value={form.organization_id||''} onChange={e=>setForm({...form,organization_id:e.target.value})}><option value="">‚Äî</option>{tree.map(o=><option key={o.id} value={o.id}>{o.name}</option>)}</select></div></Modal>
    <Modal isOpen={showModal==='res'} onClose={()=>setShowModal(null)} title={form.id?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –†–≠–°':'–ù–æ–≤—ã–π –†–≠–°'}
      footer={<><button className="btn btn-outline" onClick={()=>setShowModal(null)}>–û—Ç–º–µ–Ω–∞</button><button className="btn btn-primary" onClick={save}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></>}>
      <div className="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input className="form-control" value={form.name||''} onChange={e=>setForm({...form,name:e.target.value})} /></div>
      <div className="form-group"><label>–ö–æ–¥</label><input className="form-control" value={form.code||''} onChange={e=>setForm({...form,code:e.target.value})} /></div>
      <div className="form-group"><label>–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</label><select className="form-control" value={form.enterprise_id||''} onChange={e=>setForm({...form,enterprise_id:e.target.value})}><option value="">‚Äî</option>{enterprises.map(e=><option key={e.id} value={e.id}>{e.name}</option>)}</select></div></Modal>
  </div>;
};

// ============ ADMIN: USERS ============
const AdminUsers = () => {
  const [users, setUsers] = useState([]); const [roles, setRoles] = useState([]);
  const [orgs, setOrgs] = useState([]); const [ents, setEnts] = useState([]); const [resU, setResU] = useState([]);
  const [showModal, setShowModal] = useState(false); const [form, setForm] = useState({});
  const [loading, setLoading] = useState(true);
  const load = useCallback(() => {
    Promise.all([API.get('/admin/users'),API.get('/auth/roles'),API.get('/org/organizations'),API.get('/org/enterprises'),API.get('/org/res-units')])
      .then(([u,r,o,e,res])=>{setUsers(u);setRoles(r);setOrgs(o);setEnts(e);setResU(res);}).catch(console.error).finally(()=>setLoading(false));
  }, []);
  useEffect(()=>{load();},[load]);
  const save = async () => { try { await API.post('/auth/register',form); setShowModal(false);setForm({});load(); } catch(e){alert(e?.response?.data?.error||'–û—à–∏–±–∫–∞');} };
  if(loading) return <div className="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;
  return <div>
    <div className="page-header"><h1>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ({users.length})</h1><button className="btn btn-primary" onClick={()=>{setForm({});setShowModal(true)}}>+ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</button></div>
    <div className="card"><div className="table-container"><table><thead><tr><th>–õ–æ–≥–∏–Ω</th><th>–§–ò–û</th><th>–†–æ–ª—å</th><th>–£—Ä–æ–≤–µ–Ω—å</th><th>–ü—Ä–∏–≤—è–∑–∫–∞</th><th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead>
      <tbody>{users.map(u=><tr key={u.id}><td style={{fontWeight:500}}>{u.username}</td><td>{u.full_name||'‚Äî'}</td><td>{u.role_name||'‚Äî'}</td><td><span className="badge">{u.role_level||'‚Äî'}</span></td>
        <td className="text-muted">{u.organization_name||u.enterprise_name||u.res_name||'‚Äî'}</td><td className="text-muted">{fmtDateTime(u.last_login)}</td>
        <td>{u.is_active?<span className="badge badge-success">–ê–∫—Ç–∏–≤–µ–Ω</span>:<span className="badge badge-danger">–û—Ç–∫–ª—é—á–µ–Ω</span>}</td></tr>)}</tbody></table></div></div>
    <Modal isOpen={showModal} onClose={()=>setShowModal(false)} title="–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
      footer={<><button className="btn btn-outline" onClick={()=>setShowModal(false)}>–û—Ç–º–µ–Ω–∞</button><button className="btn btn-primary" onClick={save}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></>}>
      <div className="form-row"><div className="form-group"><label>–õ–æ–≥–∏–Ω *</label><input className="form-control" value={form.username||''} onChange={e=>setForm({...form,username:e.target.value})} /></div>
        <div className="form-group"><label>–ü–∞—Ä–æ–ª—å *</label><input className="form-control" type="password" value={form.password||''} onChange={e=>setForm({...form,password:e.target.value})} /></div></div>
      <div className="form-group"><label>–§–ò–û *</label><input className="form-control" value={form.full_name||''} onChange={e=>setForm({...form,full_name:e.target.value})} /></div>
      <div className="form-row"><div className="form-group"><label>Email</label><input className="form-control" value={form.email||''} onChange={e=>setForm({...form,email:e.target.value})} /></div>
        <div className="form-group"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input className="form-control" value={form.phone||''} onChange={e=>setForm({...form,phone:e.target.value})} /></div></div>
      <div className="form-group"><label>–†–æ–ª—å *</label><select className="form-control" value={form.role_id||''} onChange={e=>setForm({...form,role_id:e.target.value})}><option value="">‚Äî</option>{roles.map(r=><option key={r.id} value={r.id}>{r.display_name} ({r.level})</option>)}</select></div>
      <div className="form-row"><div className="form-group"><label>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</label><select className="form-control" value={form.organization_id||''} onChange={e=>setForm({...form,organization_id:e.target.value||null})}><option value="">‚Äî</option>{orgs.map(o=><option key={o.id} value={o.id}>{o.name}</option>)}</select></div>
        <div className="form-group"><label>–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</label><select className="form-control" value={form.enterprise_id||''} onChange={e=>setForm({...form,enterprise_id:e.target.value||null})}><option value="">‚Äî</option>{ents.map(e=><option key={e.id} value={e.id}>{e.name}</option>)}</select></div>
        <div className="form-group"><label>–†–≠–°</label><select className="form-control" value={form.res_unit_id||''} onChange={e=>setForm({...form,res_unit_id:e.target.value||null})}><option value="">‚Äî</option>{resU.map(r=><option key={r.id} value={r.id}>{r.name}</option>)}</select></div></div>
    </Modal>
  </div>;
};

// ============ ADMIN: AUDIT ============
const AdminAudit = () => {
  const [logs, setLogs] = useState([]); const [filters, setFilters] = useState({table_name:'',action:''});
  const [loading, setLoading] = useState(true);
  const load = useCallback(() => {
    const p = new URLSearchParams(); Object.entries(filters).forEach(([k,v])=>{if(v)p.append(k,v)});
    API.get(`/admin/audit?${p}`).then(setLogs).catch(console.error).finally(()=>setLoading(false));
  }, [filters]);
  useEffect(()=>{load();},[load]);
  const actionLabel = a=>({create:'–°–æ–∑–¥–∞–Ω–∏–µ',update:'–ò–∑–º–µ–Ω–µ–Ω–∏–µ',delete:'–£–¥–∞–ª–µ–Ω–∏–µ'}[a]||a);
  const actionBadge = a=>({create:'badge badge-success',update:'badge badge-warning',delete:'badge badge-danger'}[a]||'badge');
  const tblLabel = t=>({employees:'–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏',siz_items:'–°–ò–ó',siz_transactions:'–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏',positions:'–î–æ–ª–∂–Ω–æ—Å—Ç–∏',siz_categories:'–ö–∞—Ç–µ–≥–æ—Ä–∏–∏'}[t]||t);
  if(loading) return <div className="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;
  return <div>
    <div className="page-header"><h1>–ñ—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞</h1><span className="text-muted">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 100</span></div>
    <div className="card" style={{marginBottom:16}}><div className="form-row">
      <div className="form-group"><select className="form-control" value={filters.table_name} onChange={e=>setFilters({...filters,table_name:e.target.value})}><option value="">–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã</option><option value="employees">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option><option value="siz_items">–°–ò–ó</option><option value="siz_transactions">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</option><option value="positions">–î–æ–ª–∂–Ω–æ—Å—Ç–∏</option></select></div>
      <div className="form-group"><select className="form-control" value={filters.action} onChange={e=>setFilters({...filters,action:e.target.value})}><option value="">–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è</option><option value="create">–°–æ–∑–¥–∞–Ω–∏–µ</option><option value="update">–ò–∑–º–µ–Ω–µ–Ω–∏–µ</option><option value="delete">–£–¥–∞–ª–µ–Ω–∏–µ</option></select></div>
    </div></div>
    <div className="card"><div className="table-container"><table><thead><tr><th>–î–∞—Ç–∞/–≤—Ä–µ–º—è</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th><th>–¢–∞–±–ª–∏—Ü–∞</th><th>–ò–∑–º–µ–Ω–µ–Ω–∏—è</th></tr></thead>
      <tbody>{!logs.length?<tr><td colSpan="5"><div className="empty-state"><div className="icon">üìú</div>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div></td></tr>:
        logs.map(l=><tr key={l.id}><td className="text-muted" style={{whiteSpace:'nowrap'}}>{fmtDateTime(l.created_at)}</td><td style={{fontWeight:500}}>{l.user_name||l.username||'‚Äî'}</td>
          <td><span className={actionBadge(l.action)}>{actionLabel(l.action)}</span></td><td>{tblLabel(l.table_name)}</td>
          <td>{l.changes&&<details><summary>–ü—Ä–æ—Å–º–æ—Ç—Ä</summary><pre>{JSON.stringify(l.changes,null,2)}</pre></details>}</td></tr>)}</tbody></table></div></div>
  </div>;
};

// ============ MAIN APP ============
const App = () => {
  const { user, logout, hasPerm, isLevel } = useAuth();
  const { path, navigate } = useRoute();

  if (!user) return <LoginPage />;
  if (path === '/login') { navigate('/'); return null; }

  // Route matching
  const empMatch = path.match(/^\/employees\/(.+)$/);
  let content;
  if (path === '/' || path === '') content = <Dashboard />;
  else if (path === '/employees') content = <Employees navigate={navigate} />;
  else if (empMatch) content = <EmployeeCard id={empMatch[1]} navigate={navigate} />;
  else if (path === '/transactions') content = <Transactions navigate={navigate} />;
  else if (path === '/directories') content = <Directories />;
  else if (path === '/positions') content = <Positions />;
  else if (path === '/org-structure') content = <OrgStructure />;
  else if (path === '/admin/users' && isLevel(['ia'])) content = <AdminUsers />;
  else if (path === '/admin/audit' && isLevel(['ia'])) content = <AdminAudit />;
  else content = <Dashboard />;

  const NavLink = ({ to, children }) => (
    <a href={`#${to}`} className={`nav-link ${path===to?'active':''}`}>{children}</a>
  );

  return <div className="app-layout">
    <aside className="sidebar">
      <div className="sidebar-header"><h2>ü¶∫ –°–ò–ó</h2></div>
      <div className="sidebar-user"><div style={{fontWeight:600,color:'#fff'}}>{user.full_name}</div><div className="role">{user.role_display_name}</div></div>
      <nav>
        <div className="nav-section">–û—Å–Ω–æ–≤–Ω–æ–µ</div>
        <NavLink to="/">üìä –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</NavLink>
        <NavLink to="/employees">üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</NavLink>
        <NavLink to="/transactions">üìã –î–≤–∏–∂–µ–Ω–∏–µ –°–ò–ó</NavLink>
        <div className="nav-section">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</div>
        <NavLink to="/directories">üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –°–ò–ó</NavLink>
        <NavLink to="/positions">üíº –î–æ–ª–∂–Ω–æ—Å—Ç–∏</NavLink>
        <NavLink to="/org-structure">üè¢ –û—Ä–≥—Å—Ç—Ä—É–∫—Ç—É—Ä–∞</NavLink>
        {isLevel(['ia']) && <>
          <div className="nav-section">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
          <NavLink to="/admin/users">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</NavLink>
          <NavLink to="/admin/audit">üìú –ñ—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞</NavLink>
        </>}
      </nav>
      <div className="sidebar-footer">
        <button onClick={()=>{logout();navigate('/login')}} className="btn btn-outline" style={{width:'100%',color:'#fff',borderColor:'rgba(255,255,255,.2)'}}>–í—ã–π—Ç–∏</button>
      </div>
    </aside>
    <main className="main-content">{content}</main>
  </div>;
};

// ============ RENDER ============
ReactDOM.createRoot(document.getElementById('root')).render(<AuthProvider><App /></AuthProvider>);
</script>
</body>
</html>
