<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>СИЗ — Учёт средств защиты</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#F0F2F5;--bg2:#FFFFFF;--sidebar:#0C1829;--sidebar2:#111F36;
  --tx1:#101828;--tx2:#667085;--tx3:#98A2B3;
  --blue:#2563EB;--blue-d:#1D4ED8;--blue-l:#EFF6FF;--blue-l2:#DBEAFE;
  --green:#059669;--green-l:#ECFDF5;--green-l2:#D1FAE5;
  --red:#DC2626;--red-l:#FEF2F2;--red-l2:#FEE2E2;
  --amber:#D97706;--amber-l:#FFFBEB;
  --border:#E5E7EB;--border2:#D1D5DB;
  --radius:8px;--radius2:12px;
  --sw:260px;
  --shadow:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);
  --shadow2:0 4px 16px rgba(0,0,0,.08);
}
html{font-size:14px}
body{font-family:'Manrope',sans-serif;background:var(--bg);color:var(--tx1);line-height:1.5;-webkit-font-smoothing:antialiased}
input,select,textarea,button{font-family:inherit;font-size:inherit}

/* Layout */
.app{display:flex;min-height:100vh}
.sidebar{width:var(--sw);background:var(--sidebar);position:fixed;top:0;left:0;bottom:0;display:flex;flex-direction:column;z-index:100;overflow-y:auto}
.sidebar::-webkit-scrollbar{width:4px}
.sidebar::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:4px}
.main{margin-left:var(--sw);flex:1;padding:28px 32px;min-height:100vh}

/* Sidebar */
.sb-logo{padding:20px 22px;display:flex;align-items:center;gap:14px;border-bottom:1px solid rgba(255,255,255,.06)}
.sb-logo-icon{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#3B82F6,#1D4ED8);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(37,99,235,.3)}
.sb-logo-text{font-weight:800;font-size:20px;color:#fff;letter-spacing:.5px}
.sb-logo-sub{font-size:11px;color:rgba(255,255,255,.35);font-weight:500;margin-top:-2px}
.sb-nav{flex:1;padding:12px 0}
.sb-section{padding:18px 22px 6px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:rgba(255,255,255,.25)}
.sb-link{display:flex;align-items:center;gap:12px;padding:10px 22px;color:rgba(255,255,255,.5);font-weight:500;font-size:13px;cursor:pointer;transition:all .15s;border-left:3px solid transparent;position:relative}
.sb-link:hover{color:rgba(255,255,255,.85);background:rgba(255,255,255,.04)}
.sb-link.active{color:#fff;background:rgba(37,130,246,.12);border-left-color:#3B82F6}
.sb-link.active::after{content:'';position:absolute;right:0;top:50%;transform:translateY(-50%);width:3px;height:20px;background:#3B82F6;border-radius:3px 0 0 3px}
.sb-link svg{width:18px;height:18px;flex-shrink:0;opacity:.7}
.sb-link.active svg{opacity:1}
.sb-footer{padding:16px 22px;border-top:1px solid rgba(255,255,255,.06)}

/* Page */
.page-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:12px}
.page-top h1{font-size:24px;font-weight:800;color:var(--tx1)}
.page-top .sub{font-size:13px;color:var(--tx2);font-weight:500;margin-top:2px}
.breadcrumb{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--tx3);margin-bottom:16px;font-weight:500}
.breadcrumb span{cursor:pointer;color:var(--blue);transition:color .15s}
.breadcrumb span:hover{color:var(--blue-d)}

/* Card */
.card{background:var(--bg2);border-radius:var(--radius2);border:1px solid var(--border);box-shadow:var(--shadow);margin-bottom:16px}
.card-h{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.card-h h3{font-size:15px;font-weight:700}
.card-body{padding:20px}
.card-body.np{padding:0}

/* Stats */
.stats{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.stat{background:var(--bg2);border-radius:var(--radius2);border:1px solid var(--border);padding:20px;box-shadow:var(--shadow);display:flex;gap:16px;align-items:flex-start}
.stat-ic{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.stat-ic svg{width:22px;height:22px}
.stat-ic.bl{background:var(--blue-l);color:var(--blue)}
.stat-ic.gr{background:var(--green-l);color:var(--green)}
.stat-ic.rd{background:var(--red-l);color:var(--red)}
.stat-ic.am{background:var(--amber-l);color:var(--amber)}
.stat-val{font-size:28px;font-weight:800;font-family:'JetBrains Mono',monospace;line-height:1}
.stat-lbl{font-size:12px;color:var(--tx2);font-weight:500;margin-top:4px}

/* Table */
.tbl-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse}
thead th{background:var(--bg);font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--tx2);padding:10px 14px;text-align:left;border-bottom:2px solid var(--border);white-space:nowrap;position:sticky;top:0;z-index:1}
tbody td{padding:10px 14px;border-bottom:1px solid #F3F4F6;font-size:13px;vertical-align:middle}
tbody tr{transition:background .1s}
tbody tr:hover{background:#F9FAFB}
tbody tr:last-child td{border-bottom:none}

/* Badge */
.badge{display:inline-flex;align-items:center;padding:2px 10px;border-radius:20px;font-size:11px;font-weight:600;white-space:nowrap}
.b-blue{background:var(--blue-l2);color:#1E40AF}
.b-green{background:var(--green-l2);color:#065F46}
.b-red{background:var(--red-l2);color:#991B1B}
.b-amber{background:#FEF3C7;color:#92400E}
.b-gray{background:#F3F4F6;color:#4B5563}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 18px;border-radius:var(--radius);font-size:13px;font-weight:600;border:none;cursor:pointer;transition:all .15s;white-space:nowrap}
.btn:active{transform:scale(.97)}
.btn-p{background:var(--blue);color:#fff}.btn-p:hover{background:var(--blue-d)}
.btn-o{background:#fff;border:1px solid var(--border2);color:var(--tx1)}.btn-o:hover{background:var(--bg);border-color:var(--tx3)}
.btn-d{background:var(--red);color:#fff}.btn-d:hover{background:#B91C1C}
.btn-g{background:var(--green);color:#fff}.btn-g:hover{background:#047857}
.btn-sm{padding:5px 12px;font-size:12px;border-radius:6px}
.btn-icon{padding:6px;border-radius:6px;background:none;border:1px solid transparent;cursor:pointer;color:var(--tx2);transition:all .15s;display:inline-flex}
.btn-icon:hover{background:var(--bg);border-color:var(--border);color:var(--tx1)}

/* Form */
.fg{margin-bottom:14px}
.fg label{display:block;font-size:11px;font-weight:700;color:var(--tx2);margin-bottom:5px;text-transform:uppercase;letter-spacing:.3px}
.fc{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:var(--radius);font-size:13px;background:#fff;transition:all .15s;color:var(--tx1)}
.fc:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.fc::placeholder{color:var(--tx3)}
select.fc{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23667085' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px}
.fr{display:flex;gap:12px;flex-wrap:wrap}.fr .fg{min-width:140px}
textarea.fc{resize:vertical;min-height:80px}

/* Modal */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px;backdrop-filter:blur(4px);animation:fadeIn .15s}
.modal{background:#fff;border-radius:16px;width:100%;max-width:620px;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 24px 64px rgba(0,0,0,.2);animation:slideUp .2s}
.modal.wide{max-width:900px}
.modal-h{display:flex;justify-content:space-between;align-items:center;padding:18px 24px;border-bottom:1px solid var(--border)}
.modal-h h2{font-size:17px;font-weight:700}
.modal-b{padding:24px;overflow-y:auto;flex:1}
.modal-f{padding:14px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* Tabs */
.tabs{display:flex;gap:0;border-bottom:2px solid var(--border);margin-bottom:20px;overflow-x:auto}
.tab{padding:10px 20px;font-size:13px;font-weight:600;color:var(--tx2);cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s;white-space:nowrap}
.tab:hover{color:var(--tx1)}
.tab.active{color:var(--blue);border-bottom-color:var(--blue)}

/* Tree */
.tree-node{margin-left:0}
.tree-node.child{margin-left:28px;border-left:2px solid var(--border);padding-left:16px}
.tree-item{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-radius:var(--radius);cursor:pointer;transition:all .1s;margin-bottom:2px}
.tree-item:hover{background:var(--blue-l)}
.tree-item.sel{background:var(--blue-l2)}
.tree-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;margin-right:10px;flex-shrink:0}
.tree-icon.org{background:linear-gradient(135deg,#818CF8,#6366F1);color:#fff}
.tree-icon.ent{background:linear-gradient(135deg,#3B82F6,#2563EB);color:#fff}
.tree-icon.spb{background:linear-gradient(135deg,#F59E0B,#D97706);color:#fff}
.tree-icon.res{background:linear-gradient(135deg,#10B981,#059669);color:#fff}
.tree-icon.dep{background:linear-gradient(135deg,#8B5CF6,#7C3AED);color:#fff}

/* Chip / Tag */
.chip{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:6px;font-size:11px;font-weight:600;cursor:default}
.chip-g{background:var(--green-l2);color:#065F46}
.chip-r{background:var(--red-l2);color:#991B1B}

/* Grid PPE */
.ppe-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
.ppe-card{border:2px solid var(--border);border-radius:var(--radius);padding:10px 12px;font-size:12px;transition:all .15s;cursor:pointer;position:relative}
.ppe-card.assigned{border-color:var(--green);background:var(--green-l)}
.ppe-card.not-assigned{border-color:var(--red-l2);background:var(--red-l);opacity:.6}
.ppe-card .ppe-name{font-weight:700;font-size:12px;margin-bottom:4px;line-height:1.3}
.ppe-card .ppe-meta{color:var(--tx2);font-size:11px}
.ppe-card .ppe-dates{margin-top:6px;font-size:11px;font-family:'JetBrains Mono',monospace}
.ppe-card .ppe-dot{position:absolute;top:8px;right:8px;width:8px;height:8px;border-radius:50%}
.ppe-card.assigned .ppe-dot{background:var(--green)}
.ppe-card.not-assigned .ppe-dot{background:var(--red)}

/* Empty */
.empty{text-align:center;padding:48px 20px;color:var(--tx3)}
.empty svg{width:48px;height:48px;margin-bottom:12px;opacity:.4}
.empty p{font-size:14px;font-weight:500}

/* Search */
.search-box{position:relative}
.search-box input{padding-left:36px}
.search-box svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);width:16px;height:16px;color:var(--tx3)}

/* Scrollbar */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#D1D5DB;border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:#9CA3AF}

/* Loading animation */
.loader-wrap{position:fixed;inset:0;background:var(--sidebar);display:flex;align-items:center;justify-content:center;z-index:9999;transition:opacity .4s,visibility .4s}
.loader-wrap.hide{opacity:0;visibility:hidden;pointer-events:none}
.loader-hex{position:relative;width:120px;height:120px}
.loader-hex svg{width:100%;height:100%}

/* Personnel table special */
.ptbl{font-size:12px}
.ptbl th{font-size:10px;padding:8px 6px;text-align:center}
.ptbl td{padding:6px;text-align:center;font-size:11px}
.ptbl .name-col{text-align:left;font-weight:600;white-space:nowrap;min-width:160px;position:sticky;left:0;background:inherit;z-index:1}
.ptbl thead .name-col{background:var(--bg)}
.ptbl .siz-ok{background:#ECFDF5;color:#065F46;font-weight:600}
.ptbl .siz-no{background:#FEF2F2;color:#991B1B;font-weight:500}
.ptbl .siz-exp{background:#FFFBEB;color:#92400E;font-weight:600}
.ptbl tbody tr:hover td{background:#F0F9FF}
.ptbl tbody tr:hover .siz-ok{background:#D1FAE5}
.ptbl tbody tr:hover .siz-no{background:#FEE2E2}

/* Category icons */
.cat-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:18px}
.cat-clothes{background:#EDE9FE;color:#7C3AED}
.cat-shoes{background:#FEF3C7;color:#D97706}
.cat-head{background:#E0E7FF;color:#4338CA}
.cat-gloves{background:#FCE7F3;color:#DB2777}
.cat-consumable{background:#ECFDF5;color:#059669}

/* Toast */
.toast{position:fixed;bottom:24px;right:24px;background:#1F2937;color:#fff;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:500;z-index:2000;animation:slideUp .3s;box-shadow:0 8px 24px rgba(0,0,0,.2);display:flex;align-items:center;gap:8px;max-width:360px}
.toast.success{background:#059669}.toast.error{background:#DC2626}

/* Responsive */
@media(max-width:768px){
  .sidebar{width:0;overflow:hidden}.main{margin-left:0;padding:16px}
  .stats{grid-template-columns:1fr 1fr}.fr{flex-direction:column}
}
</style>
</head>
<body>
<div class="loader-wrap" id="loader">
  <div class="loader-hex">
    <svg viewBox="0 0 120 120">
      <defs>
        <filter id="glow"><feGaussianBlur stdDeviation="2" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
      </defs>
      <polygon points="60,10 105,35 105,85 60,110 15,85 15,35" fill="none" stroke="#1E3A5F" stroke-width="2"/>
      <polygon points="60,10 105,35 105,85 60,110 15,85 15,35" fill="none" stroke="#3B82F6" stroke-width="2.5" stroke-dasharray="300" stroke-dashoffset="300" filter="url(#glow)">
        <animate attributeName="stroke-dashoffset" values="300;0;300" dur="2s" repeatCount="indefinite"/>
      </polygon>
      <text x="60" y="58" text-anchor="middle" fill="#3B82F6" font-family="Manrope" font-weight="800" font-size="16">СИЗ</text>
      <text x="60" y="74" text-anchor="middle" fill="#667085" font-family="Manrope" font-weight="500" font-size="8">Загрузка...</text>
    </svg>
  </div>
</div>

<div id="root"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.3.1/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.3.1/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.26.2/babel.min.js"></script>

<script type="text/babel">
const {useState, useEffect, useCallback, createContext, useContext, useRef, useMemo} = React;

// ═══════════════════════════════════════
// ICONS (inline SVG components)
// ═══════════════════════════════════════
const IC = {
  shield: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
  home: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
  users: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
  user: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
  building: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01M16 6h.01M12 6h.01M12 10h.01M12 14h.01M16 10h.01M16 14h.01M8 10h.01M8 14h.01"/></svg>,
  folder: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>,
  package: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>,
  briefcase: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
  scroll: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 21h12a2 2 0 0 0 2-2v-2H10v2a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v3h4"/><path d="M19 17V5a2 2 0 0 0-2-2H4"/></svg>,
  plus: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
  edit: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
  trash: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
  search: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
  check: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
  x: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
  chevDown: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>,
  chevRight: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>,
  arrowLeft: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
  link: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
  warehouse: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 8.35V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8.35A2 2 0 0 1 3.26 6.5l8-3.2a2 2 0 0 1 1.48 0l8 3.2A2 2 0 0 1 22 8.35Z"/><path d="M6 18h12"/><path d="M6 14h12"/><rect x="6" y="10" width="12" height="12"/></svg>,
  shirt: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.38 3.46L16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"/></svg>,
  boot: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7 21h10l3-3V9l-3 3H7V5a2 2 0 0 0-2-2H3v16a2 2 0 0 0 2 2h2z"/></svg>,
  hardhat: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 18a1 1 0 0 0 1 1h18a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v2z"/><path d="M10 15V6a2 2 0 0 1 4 0v9"/><path d="M4 15v-3a8 8 0 0 1 16 0v3"/></svg>,
  hand: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 11V6a2 2 0 0 0-4 0v1"/><path d="M14 10V4a2 2 0 0 0-4 0v2"/><path d="M10 10.5V6a2 2 0 0 0-4 0v8"/><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/></svg>,
  droplet: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>,
  calendar: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
  clock: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
  settings: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
  eye: p => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
};

// ═══════════════════════════════════════
// DATA STORE (localStorage based)
// ═══════════════════════════════════════
const LS = {
  get(k, def) { try { const v = localStorage.getItem('siz_' + k); return v ? JSON.parse(v) : def; } catch { return def; } },
  set(k, v) { localStorage.setItem('siz_' + k, JSON.stringify(v)); },
};

const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
const fmtDate = d => d ? new Date(d).toLocaleDateString('ru-RU') : '—';
const addYears = (d, y) => { const dt = new Date(d); dt.setFullYear(dt.getFullYear() + y); return dt.toISOString().split('T')[0]; };
const isExpired = d => d && new Date(d) < new Date();
const isExpiringSoon = d => { if (!d) return false; const diff = (new Date(d) - new Date()) / (1000*60*60*24); return diff > 0 && diff <= 30; };

// Category config
const CATEGORIES = [
  { key: 'clothes', name: 'ОДЕЖДА', icon: 'shirt', cls: 'cat-clothes', hasSizes: true, sizeType: 'clothing' },
  { key: 'shoes', name: 'ОБУВЬ', icon: 'boot', cls: 'cat-shoes', hasSizes: true, sizeType: 'shoes' },
  { key: 'head', name: 'ГОЛОВА', icon: 'hardhat', cls: 'cat-head', hasSizes: false, sizeLabel: 'Универсальный' },
  { key: 'gloves', name: 'ПЕРЧАТКИ', icon: 'hand', cls: 'cat-gloves', hasSizes: false, sizeLabel: 'Универсальный' },
  { key: 'consumable', name: 'РАСХОДНИК', icon: 'droplet', cls: 'cat-consumable', hasSizes: false, sizeLabel: 'шт/мл' },
];
const catByKey = k => CATEGORIES.find(c => c.key === k);
const catIcon = k => { const c = catByKey(k); if (!c) return null; return IC[c.icon]; };

const CLOTHING_SIZES = [
  '40-42/158-164','40-42/170-176','40-42/182-188','40-42/194-200',
  '44-46/158-164','44-46/170-176','44-46/182-188','44-46/194-200',
  '48-50/158-164','48-50/170-176','48-50/182-188','48-50/194-200',
  '52-54/158-164','52-54/170-176','52-54/182-188','52-54/194-200',
  '56-58/158-164','56-58/170-176','56-58/182-188','56-58/194-200',
  '60-62/158-164','60-62/170-176','60-62/182-188','60-62/194-200',
  '64-66/158-164','64-66/170-176','64-66/182-188','64-66/194-200',
  '68-70/158-164','68-70/170-176','68-70/182-188','68-70/194-200',
  '72-74/158-164','72-74/170-176','72-74/182-188','72-74/194-200',
];
const SHOE_SIZES = Array.from({length:15},(_,i)=>String(35+i));
const GENDERS = ['Мужской','Женский'];
const SEASONS = ['Лето','Зима','Всесезонный'];

// ═══════════════════════════════════════
// GLOBAL STATE CONTEXT
// ═══════════════════════════════════════
const StoreCtx = createContext(null);

const StoreProvider = ({children}) => {
  // Org structure
  const [org, setOrg] = useState(() => LS.get('org', { id: uid(), name: 'ИнтерЭнерго', code: 'ИЭ' }));
  const [enterprises, setEnterprises] = useState(() => LS.get('enterprises', []));
  const [spbipks, setSpbipks] = useState(() => LS.get('spbipks', []));
  const [resUnits, setResUnits] = useState(() => LS.get('resUnits', []));
  const [departments, setDepartments] = useState(() => LS.get('departments', []));

  // Directories
  const [positions, setPositions] = useState(() => LS.get('positions', []));
  const [sizItems, setSizItems] = useState(() => LS.get('sizItems', []));

  // Personnel
  const [employees, setEmployees] = useState(() => LS.get('employees', []));

  // TON norms (position -> siz_item mappings)
  const [norms, setNorms] = useState(() => LS.get('norms', []));

  // Employee issued SIZ
  const [issued, setIssued] = useState(() => LS.get('issued', []));

  // Toast
  const [toast, setToast] = useState(null);
  const showToast = (msg, type='success') => { setToast({msg,type}); setTimeout(()=>setToast(null), 3000); };

  // Persist
  useEffect(() => LS.set('org', org), [org]);
  useEffect(() => LS.set('enterprises', enterprises), [enterprises]);
  useEffect(() => LS.set('spbipks', spbipks), [spbipks]);
  useEffect(() => LS.set('resUnits', resUnits), [resUnits]);
  useEffect(() => LS.set('departments', departments), [departments]);
  useEffect(() => LS.set('positions', positions), [positions]);
  useEffect(() => LS.set('sizItems', sizItems), [sizItems]);
  useEffect(() => LS.set('employees', employees), [employees]);
  useEffect(() => LS.set('norms', norms), [norms]);
  useEffect(() => LS.set('issued', issued), [issued]);

  const val = {
    org, setOrg,
    enterprises, setEnterprises,
    spbipks, setSpbipks,
    resUnits, setResUnits,
    departments, setDepartments,
    positions, setPositions,
    sizItems, setSizItems,
    employees, setEmployees,
    norms, setNorms,
    issued, setIssued,
    toast, showToast,
  };
  return <StoreCtx.Provider value={val}>{children}</StoreCtx.Provider>;
};
const useStore = () => useContext(StoreCtx);

// ═══════════════════════════════════════
// SHARED COMPONENTS
// ═══════════════════════════════════════
const Modal = ({open, onClose, title, wide, children, footer}) => {
  if (!open) return null;
  return <div className="modal-bg" onClick={onClose}>
    <div className={`modal ${wide?'wide':''}`} onClick={e=>e.stopPropagation()}>
      <div className="modal-h"><h2>{title}</h2><button className="btn-icon" onClick={onClose}><IC.x style={{width:18,height:18}}/></button></div>
      <div className="modal-b">{children}</div>
      {footer && <div className="modal-f">{footer}</div>}
    </div>
  </div>;
};

const Empty = ({icon:Icon, text}) => <div className="empty">{Icon && <Icon style={{width:48,height:48}}/>}<p>{text || 'Нет данных'}</p></div>;

const SearchInput = ({value, onChange, placeholder}) => <div className="search-box">
  <IC.search style={{width:16,height:16}}/>
  <input className="fc" value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder || 'Поиск...'} style={{paddingLeft:36}}/>
</div>;

// ═══════════════════════════════════════
// PAGES
// ═══════════════════════════════════════

// ---- DASHBOARD ----
const Dashboard = () => {
  const s = useStore();
  const totalEmp = s.employees.length;
  const totalSiz = s.sizItems.length;
  const totalPos = s.positions.length;
  const totalNorms = s.norms.length;
  const totalIssued = s.issued.filter(i=>i.status==='active').length;
  const expiredCount = s.issued.filter(i => i.status==='active' && i.expiryDate && isExpired(i.expiryDate)).length;

  return <div>
    <div className="page-top"><div><h1>Панель управления</h1><div className="sub">Учёт средств индивидуальной защиты</div></div></div>
    <div className="stats">
      <div className="stat"><div className="stat-ic bl"><IC.users style={{width:22,height:22}}/></div><div><div className="stat-val">{totalEmp}</div><div className="stat-lbl">Сотрудников</div></div></div>
      <div className="stat"><div className="stat-ic gr"><IC.shield style={{width:22,height:22}}/></div><div><div className="stat-val">{totalSiz}</div><div className="stat-lbl">Наименований СИЗ</div></div></div>
      <div className="stat"><div className="stat-ic am"><IC.briefcase style={{width:22,height:22}}/></div><div><div className="stat-val">{totalPos}</div><div className="stat-lbl">Должностей</div></div></div>
      <div className="stat"><div className="stat-ic rd"><IC.clock style={{width:22,height:22}}/></div><div><div className="stat-val">{expiredCount}</div><div className="stat-lbl">Просрочено</div></div></div>
    </div>

    <div className="card"><div className="card-h"><h3>Быстрый старт</h3></div><div className="card-body">
      <p style={{color:'var(--tx2)',marginBottom:16,fontSize:13}}>Для начала работы выполните действия в следующем порядке:</p>
      <div style={{display:'flex',flexDirection:'column',gap:10}}>
        {[
          {n:1,t:'Оргструктура',d:'Создайте предприятие, СПБиПК, РЭС/Службы и подразделения',done:s.enterprises.length>0},
          {n:2,t:'Должности',d:'Заполните справочник должностей',done:s.positions.length>0},
          {n:3,t:'Справочники СИЗ',d:'Занесите все виды СИЗ по категориям (одежда, обувь, голова, перчатки, расходники)',done:s.sizItems.length>0},
          {n:4,t:'ТОН (Типовые нормы)',d:'Привяжите СИЗ к должностям — какие положены',done:s.norms.length>0},
          {n:5,t:'Карточки персонала',d:'Создайте карточки сотрудников с привязкой к оргструктуре',done:s.employees.length>0},
        ].map(s => <div key={s.n} style={{display:'flex',alignItems:'center',gap:14,padding:'10px 14px',borderRadius:8,background:s.done?'var(--green-l)':'var(--bg)',border:`1px solid ${s.done?'var(--green-l2)':'var(--border)'}`}}>
          <div style={{width:32,height:32,borderRadius:'50%',background:s.done?'var(--green)':'var(--border)',color:'#fff',display:'flex',alignItems:'center',justifyContent:'center',fontWeight:700,fontSize:14,flexShrink:0}}>
            {s.done ? <IC.check style={{width:16,height:16}}/> : s.n}
          </div>
          <div style={{flex:1}}><div style={{fontWeight:700,fontSize:13}}>{s.t}</div><div style={{fontSize:12,color:'var(--tx2)'}}>{s.d}</div></div>
        </div>)}
      </div>
    </div></div>
  </div>;
};

// ---- ORG STRUCTURE ----
const OrgStructure = () => {
  const s = useStore();
  const [modal, setModal] = useState(null); // {type, data, parentId}
  const [form, setForm] = useState({});

  const save = () => {
    if (!form.name?.trim()) return;
    const item = { ...form, id: form.id || uid() };
    if (modal.type === 'enterprise') {
      if (form.id) s.setEnterprises(prev => prev.map(e => e.id === form.id ? item : e));
      else s.setEnterprises(prev => [...prev, item]);
    } else if (modal.type === 'spbipk') {
      item.enterpriseId = modal.parentId;
      if (form.id) s.setSpbipks(prev => prev.map(e => e.id === form.id ? item : e));
      else s.setSpbipks(prev => [...prev, item]);
    } else if (modal.type === 'res') {
      item.enterpriseId = modal.parentId;
      if (form.id) s.setResUnits(prev => prev.map(e => e.id === form.id ? item : e));
      else s.setResUnits(prev => [...prev, item]);
    } else if (modal.type === 'dept') {
      item.resUnitId = modal.parentId;
      if (form.id) s.setDepartments(prev => prev.map(e => e.id === form.id ? item : e));
      else s.setDepartments(prev => [...prev, item]);
    }
    setModal(null); setForm({});
    s.showToast('Сохранено');
  };

  const del = (type, id) => {
    if (type === 'enterprise') s.setEnterprises(p => p.filter(e => e.id !== id));
    else if (type === 'spbipk') s.setSpbipks(p => p.filter(e => e.id !== id));
    else if (type === 'res') s.setResUnits(p => p.filter(e => e.id !== id));
    else if (type === 'dept') s.setDepartments(p => p.filter(e => e.id !== id));
    s.showToast('Удалено');
  };

  const labels = { enterprise: 'Предприятие', spbipk: 'СПБиПК', res: 'РЭС / Служба', dept: 'Подразделение' };

  return <div>
    <div className="page-top"><div><h1>Оргструктура</h1><div className="sub">Иерархия подразделений</div></div></div>

    <div className="card"><div className="card-h"><h3 style={{display:'flex',alignItems:'center',gap:8}}>
      <div className="tree-icon org" style={{width:28,height:28}}><IC.building style={{width:14,height:14}}/></div>
      {s.org.name} <span className="badge b-blue">{s.org.code}</span>
    </h3></div>
    <div className="card-body">
      <div style={{marginBottom:12,display:'flex',gap:8}}>
        <button className="btn btn-p btn-sm" onClick={()=>{setForm({});setModal({type:'enterprise'})}}><IC.plus style={{width:14,height:14}}/> Предприятие</button>
      </div>

      {s.enterprises.map(ent => {
        const entSpb = s.spbipks.filter(sp => sp.enterpriseId === ent.id);
        const entRes = s.resUnits.filter(r => r.enterpriseId === ent.id);
        return <div key={ent.id} className="tree-node child">
          <div className="tree-item">
            <div style={{display:'flex',alignItems:'center',gap:10}}>
              <div className="tree-icon ent" style={{width:28,height:28}}><IC.building style={{width:14,height:14}}/></div>
              <div><div style={{fontWeight:700,fontSize:13}}>{ent.name}</div><div style={{fontSize:11,color:'var(--tx3)'}}>Предприятие</div></div>
            </div>
            <div style={{display:'flex',gap:4}}>
              <button className="btn-icon" onClick={()=>{setForm({});setModal({type:'spbipk',parentId:ent.id})}} title="Добавить СПБиПК"><IC.plus style={{width:14,height:14}}/></button>
              <button className="btn-icon" onClick={()=>{setForm({});setModal({type:'res',parentId:ent.id})}} title="Добавить РЭС/Служба"><IC.plus style={{width:14,height:14,color:'var(--green)'}}/></button>
              <button className="btn-icon" onClick={()=>{setForm(ent);setModal({type:'enterprise'})}}><IC.edit style={{width:14,height:14}}/></button>
              <button className="btn-icon" onClick={()=>del('enterprise',ent.id)}><IC.trash style={{width:14,height:14,color:'var(--red)'}}/></button>
            </div>
          </div>

          {entSpb.map(sp => <div key={sp.id} className="tree-node child">
            <div className="tree-item">
              <div style={{display:'flex',alignItems:'center',gap:10}}>
                <div className="tree-icon spb" style={{width:26,height:26}}><IC.warehouse style={{width:13,height:13}}/></div>
                <div><div style={{fontWeight:600,fontSize:13}}>{sp.name}</div><div style={{fontSize:11,color:'var(--tx3)'}}>СПБиПК (склад)</div></div>
              </div>
              <div style={{display:'flex',gap:4}}>
                <button className="btn-icon" onClick={()=>{setForm(sp);setModal({type:'spbipk',parentId:ent.id})}}><IC.edit style={{width:14,height:14}}/></button>
                <button className="btn-icon" onClick={()=>del('spbipk',sp.id)}><IC.trash style={{width:14,height:14,color:'var(--red)'}}/></button>
              </div>
            </div>
          </div>)}

          {entRes.map(ru => {
            const ruDepts = s.departments.filter(d => d.resUnitId === ru.id);
            return <div key={ru.id} className="tree-node child">
              <div className="tree-item">
                <div style={{display:'flex',alignItems:'center',gap:10}}>
                  <div className="tree-icon res" style={{width:26,height:26}}><IC.users style={{width:13,height:13}}/></div>
                  <div><div style={{fontWeight:600,fontSize:13}}>{ru.name}</div><div style={{fontSize:11,color:'var(--tx3)'}}>РЭС / Служба</div></div>
                </div>
                <div style={{display:'flex',gap:4}}>
                  <button className="btn-icon" onClick={()=>{setForm({});setModal({type:'dept',parentId:ru.id})}} title="Добавить подразделение"><IC.plus style={{width:14,height:14}}/></button>
                  <button className="btn-icon" onClick={()=>{setForm(ru);setModal({type:'res',parentId:ent.id})}}><IC.edit style={{width:14,height:14}}/></button>
                  <button className="btn-icon" onClick={()=>del('res',ru.id)}><IC.trash style={{width:14,height:14,color:'var(--red)'}}/></button>
                </div>
              </div>
              {ruDepts.map(dp => <div key={dp.id} className="tree-node child">
                <div className="tree-item">
                  <div style={{display:'flex',alignItems:'center',gap:10}}>
                    <div className="tree-icon dep" style={{width:24,height:24}}><IC.folder style={{width:12,height:12}}/></div>
                    <div style={{fontWeight:600,fontSize:13}}>{dp.name}</div>
                  </div>
                  <div style={{display:'flex',gap:4}}>
                    <button className="btn-icon" onClick={()=>{setForm(dp);setModal({type:'dept',parentId:ru.id})}}><IC.edit style={{width:14,height:14}}/></button>
                    <button className="btn-icon" onClick={()=>del('dept',dp.id)}><IC.trash style={{width:14,height:14,color:'var(--red)'}}/></button>
                  </div>
                </div>
              </div>)}
            </div>;
          })}
        </div>;
      })}

      {!s.enterprises.length && <Empty icon={IC.building} text="Добавьте первое предприятие"/>}
    </div></div>

    <Modal open={!!modal} onClose={()=>setModal(null)} title={`${form.id?'Редактировать':'Добавить'} — ${labels[modal?.type]||''}`}
      footer={<><button className="btn btn-o" onClick={()=>setModal(null)}>Отмена</button><button className="btn btn-p" onClick={save}>Сохранить</button></>}>
      <div className="fg"><label>Название</label><input className="fc" value={form.name||''} onChange={e=>setForm({...form,name:e.target.value})} placeholder="Введите название"/></div>
      {modal?.type === 'enterprise' && <div className="fg"><label>Код</label><input className="fc" value={form.code||''} onChange={e=>setForm({...form,code:e.target.value})} placeholder="Короткий код"/></div>}
    </Modal>
  </div>;
};

// ---- POSITIONS ----
const Positions = () => {
  const s = useStore();
  const [modal, setModal] = useState(false);
  const [form, setForm] = useState({});
  const [search, setSearch] = useState('');

  const save = () => {
    if (!form.name?.trim()) return;
    const item = { ...form, id: form.id || uid() };
    if (form.id) s.setPositions(prev => prev.map(p => p.id === form.id ? item : p));
    else s.setPositions(prev => [...prev, item]);
    setModal(false); setForm({}); s.showToast('Должность сохранена');
  };

  const del = id => { s.setPositions(p => p.filter(x => x.id !== id)); s.showToast('Удалено'); };
  const filtered = s.positions.filter(p => !search || p.name.toLowerCase().includes(search.toLowerCase()));

  return <div>
    <div className="page-top"><div><h1>Должности</h1><div className="sub">Справочник должностей</div></div>
      <button className="btn btn-p" onClick={()=>{setForm({});setModal(true)}}><IC.plus style={{width:16,height:16}}/> Добавить</button>
    </div>
    <div className="card"><div className="card-h"><SearchInput value={search} onChange={setSearch} placeholder="Поиск должности..."/></div>
      <div className="card-body np"><div className="tbl-wrap"><table><thead><tr><th>Название</th><th>Код</th><th style={{width:80}}>Действия</th></tr></thead>
        <tbody>{filtered.length ? filtered.map(p => <tr key={p.id}><td style={{fontWeight:600}}>{p.name}</td><td><span className="badge b-gray">{p.code||'—'}</span></td>
          <td><div style={{display:'flex',gap:4}}><button className="btn-icon" onClick={()=>{setForm(p);setModal(true)}}><IC.edit style={{width:14,height:14}}/></button><button className="btn-icon" onClick={()=>del(p.id)}><IC.trash style={{width:14,height:14,color:'var(--red)'}}/></button></div></td>
        </tr>) : <tr><td colSpan="3"><Empty icon={IC.briefcase} text="Нет должностей"/></td></tr>}</tbody>
      </table></div></div>
    </div>
    <Modal open={modal} onClose={()=>setModal(false)} title={form.id ? 'Редактировать должность' : 'Новая должность'}
      footer={<><button className="btn btn-o" onClick={()=>setModal(false)}>Отмена</button><button className="btn btn-p" onClick={save}>Сохранить</button></>}>
      <div className="fg"><label>Название должности</label><input className="fc" value={form.name||''} onChange={e=>setForm({...form,name:e.target.value})} placeholder="Электромонтёр"/></div>
      <div className="fg"><label>Код</label><input className="fc" value={form.code||''} onChange={e=>setForm({...form,code:e.target.value})} placeholder="ЭМ-01"/></div>
    </Modal>
  </div>;
};

// ---- SIZ DIRECTORIES ----
const Directories = () => {
  const s = useStore();
  const [tab, setTab] = useState('clothes');
  const [modal, setModal] = useState(false);
  const [form, setForm] = useState({});
  const [search, setSearch] = useState('');
  const cat = catByKey(tab);

  const save = () => {
    if (!form.name?.trim()) return;
    const item = { ...form, id: form.id || uid(), category: tab };
    if (form.id) s.setSizItems(prev => prev.map(x => x.id === form.id ? item : x));
    else s.setSizItems(prev => [...prev, item]);
    setModal(false); setForm({}); s.showToast('СИЗ сохранён');
  };

  const del = id => { s.setSizItems(p => p.filter(x => x.id !== id)); s.showToast('Удалено'); };
  const items = s.sizItems.filter(i => i.category === tab && (!search || i.name.toLowerCase().includes(search.toLowerCase()) || (i.code||'').toLowerCase().includes(search.toLowerCase())));

  return <div>
    <div className="page-top"><div><h1>Справочники СИЗ</h1><div className="sub">Реестр средств защиты по категориям</div></div>
      <button className="btn btn-p" onClick={()=>{setForm({});setModal(true)}}><IC.plus style={{width:16,height:16}}/> Добавить в {cat?.name}</button>
    </div>

    <div className="tabs">
      {CATEGORIES.map(c => {
        const CatIcon = IC[c.icon];
        const count = s.sizItems.filter(i => i.category === c.key).length;
        return <button key={c.key} className={`tab ${tab===c.key?'active':''}`} onClick={()=>{setTab(c.key);setSearch('')}}>
          <span style={{display:'flex',alignItems:'center',gap:6}}><CatIcon style={{width:15,height:15}}/> {c.name} <span className="badge b-gray" style={{marginLeft:4}}>{count}</span></span>
        </button>;
      })}
    </div>

    <div className="card"><div className="card-h"><SearchInput value={search} onChange={setSearch} placeholder="Поиск по коду или названию..."/></div>
      <div className="card-body np"><div className="tbl-wrap"><table><thead><tr>
        <th>Код</th><th>Наименование</th><th>Пол</th><th>Сезон</th><th>Срок эксп. (лет)</th>
        {cat?.hasSizes && <th>Размеры</th>}
        {!cat?.hasSizes && <th>Ед. измерения</th>}
        <th style={{width:80}}>Действия</th>
      </tr></thead>
      <tbody>{items.length ? items.map(it => <tr key={it.id}>
        <td><span className="badge b-blue">{it.code||'—'}</span></td>
        <td style={{fontWeight:600}}>{it.name}</td>
        <td>{it.gender||'—'}</td>
        <td><span className={`badge ${it.season==='Зима'?'b-blue':it.season==='Лето'?'b-amber':'b-gray'}`}>{it.season||'—'}</span></td>
        <td style={{fontFamily:'JetBrains Mono',fontSize:12}}>{it.exploitYears||'—'}</td>
        <td>{cat?.hasSizes ? (cat.sizeType==='clothing'?'По размерной сетке':'35-49') : (cat?.sizeLabel||'—')}</td>
        <td><div style={{display:'flex',gap:4}}><button className="btn-icon" onClick={()=>{setForm(it);setModal(true)}}><IC.edit style={{width:14,height:14}}/></button><button className="btn-icon" onClick={()=>del(it.id)}><IC.trash style={{width:14,height:14,color:'var(--red)'}}/></button></div></td>
      </tr>) : <tr><td colSpan="7"><Empty icon={IC.shield} text={`Нет записей в категории ${cat?.name}`}/></td></tr>}</tbody>
      </table></div></div>
    </div>

    <Modal open={modal} onClose={()=>setModal(false)} title={`${form.id?'Редактировать':'Добавить'} — ${cat?.name}`}
      footer={<><button className="btn btn-o" onClick={()=>setModal(false)}>Отмена</button><button className="btn btn-p" onClick={save}>Сохранить</button></>}>
      <div className="fr">
        <div className="fg"><label>Код</label><input className="fc" value={form.code||''} onChange={e=>setForm({...form,code:e.target.value})} placeholder="001"/></div>
        <div className="fg" style={{flex:2}}><label>Наименование</label><input className="fc" value={form.name||''} onChange={e=>setForm({...form,name:e.target.value})} placeholder="Костюм хлопчатобумажный"/></div>
      </div>
      <div className="fr">
        <div className="fg"><label>Пол</label><select className="fc" value={form.gender||''} onChange={e=>setForm({...form,gender:e.target.value})}><option value="">— Выбрать —</option>{GENDERS.map(g=><option key={g}>{g}</option>)}</select></div>
        <div className="fg"><label>Сезон</label><select className="fc" value={form.season||''} onChange={e=>setForm({...form,season:e.target.value})}><option value="">— Выбрать —</option>{SEASONS.map(g=><option key={g}>{g}</option>)}</select></div>
        <div className="fg"><label>Срок эксплуатации (лет)</label><input className="fc" type="number" min="0" step="0.5" value={form.exploitYears||''} onChange={e=>setForm({...form,exploitYears:e.target.value})}/></div>
      </div>
    </Modal>
  </div>;
};

// ---- ТОН (Типовые нормы выдачи) ----
const TonPage = () => {
  const s = useStore();
  const [selPos, setSelPos] = useState('');
  const [modal, setModal] = useState(false);
  const [modalCat, setModalCat] = useState('clothes');

  const posNorms = selPos ? s.norms.filter(n => n.positionId === selPos) : [];
  const assignedIds = new Set(posNorms.map(n => n.sizItemId));

  const toggleNorm = (sizId) => {
    if (assignedIds.has(sizId)) {
      s.setNorms(prev => prev.filter(n => !(n.positionId === selPos && n.sizItemId === sizId)));
    } else {
      s.setNorms(prev => [...prev, { id: uid(), positionId: selPos, sizItemId: sizId }]);
    }
  };

  const catItems = s.sizItems.filter(i => i.category === modalCat);
  const posName = s.positions.find(p => p.id === selPos)?.name || '';

  return <div>
    <div className="page-top"><div><h1>ТОН — Типовые нормы выдачи</h1><div className="sub">Привязка СИЗ к должностям</div></div></div>

    <div className="card"><div className="card-body">
      <div className="fg"><label>Выберите должность</label>
        <select className="fc" value={selPos} onChange={e=>setSelPos(e.target.value)} style={{maxWidth:400}}>
          <option value="">— Выберите должность —</option>
          {s.positions.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
        </select>
      </div>

      {selPos && <div style={{marginTop:16}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
          <h3 style={{fontSize:16,fontWeight:700}}>Положенные СИЗ для: <span style={{color:'var(--blue)'}}>{posName}</span></h3>
          <button className="btn btn-p" onClick={()=>setModal(true)}><IC.link style={{width:16,height:16}}/> Подключить СИЗ</button>
        </div>

        {CATEGORIES.map(cat => {
          const catNorms = posNorms.filter(n => s.sizItems.find(i => i.id === n.sizItemId)?.category === cat.key);
          if (!catNorms.length) return null;
          const CatIcon = IC[cat.icon];
          return <div key={cat.key} style={{marginBottom:16}}>
            <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
              <div className={`cat-icon ${cat.cls}`} style={{width:28,height:28}}><CatIcon style={{width:14,height:14}}/></div>
              <span style={{fontWeight:700,fontSize:13}}>{cat.name}</span>
              <span className="badge b-gray">{catNorms.length}</span>
            </div>
            <div className="ppe-grid">
              {catNorms.map(n => {
                const item = s.sizItems.find(i => i.id === n.sizItemId);
                if (!item) return null;
                return <div key={n.id} className="ppe-card assigned">
                  <div className="ppe-dot"/>
                  <div className="ppe-name">{item.name}</div>
                  <div className="ppe-meta">{item.code} | {item.season||'—'} | {item.exploitYears||'?'} г.</div>
                </div>;
              })}
            </div>
          </div>;
        })}

        {!posNorms.length && <Empty icon={IC.link} text="Нет привязанных СИЗ. Нажмите «Подключить СИЗ»"/>}
      </div>}

      {!selPos && <Empty icon={IC.briefcase} text="Выберите должность для настройки норм"/>}
    </div></div>

    <Modal open={modal} onClose={()=>setModal(false)} title={`Подключение СИЗ — ${posName}`} wide
      footer={<button className="btn btn-p" onClick={()=>setModal(false)}>Готово</button>}>
      <div className="tabs" style={{marginBottom:16}}>
        {CATEGORIES.map(c => {
          const CatIcon = IC[c.icon];
          return <button key={c.key} className={`tab ${modalCat===c.key?'active':''}`} onClick={()=>setModalCat(c.key)}>
            <span style={{display:'flex',alignItems:'center',gap:6}}><CatIcon style={{width:14,height:14}}/> {c.name}</span>
          </button>;
        })}
      </div>
      {catItems.length ? <div style={{display:'flex',flexDirection:'column',gap:6}}>
        {catItems.map(it => {
          const isOn = assignedIds.has(it.id);
          return <div key={it.id} onClick={()=>toggleNorm(it.id)}
            style={{display:'flex',alignItems:'center',gap:12,padding:'10px 14px',borderRadius:8,cursor:'pointer',
              border:`2px solid ${isOn?'var(--green)':'var(--border)'}`,background:isOn?'var(--green-l)':'#fff',transition:'all .15s'}}>
            <div style={{width:22,height:22,borderRadius:6,border:`2px solid ${isOn?'var(--green)':'var(--border2)'}`,background:isOn?'var(--green)':'#fff',display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0}}>
              {isOn && <IC.check style={{width:14,height:14,color:'#fff'}}/>}
            </div>
            <div style={{flex:1}}>
              <div style={{fontWeight:700,fontSize:13}}>{it.name}</div>
              <div style={{fontSize:11,color:'var(--tx2)'}}>{it.code} | {it.gender||'—'} | {it.season||'—'} | {it.exploitYears||'?'} г.</div>
            </div>
          </div>;
        })}
      </div> : <Empty icon={IC.shield} text={`Нет СИЗ в категории. Сначала заполните справочник.`}/>}
    </Modal>
  </div>;
};

// ---- EMPLOYEES ----
const EmployeesPage = ({navigate}) => {
  const s = useStore();
  const [modal, setModal] = useState(false);
  const [form, setForm] = useState({});
  const [search, setSearch] = useState('');
  const [viewMode, setViewMode] = useState('table'); // table | matrix

  const entName = id => s.enterprises.find(e=>e.id===id)?.name||'—';
  const resName = id => s.resUnits.find(e=>e.id===id)?.name||'—';
  const deptName = id => s.departments.find(e=>e.id===id)?.name||'—';
  const posName = id => s.positions.find(e=>e.id===id)?.name||'—';

  const save = () => {
    if (!form.fio?.trim()) return;
    const item = { ...form, id: form.id || uid() };
    if (form.id) s.setEmployees(prev => prev.map(e => e.id === form.id ? item : e));
    else s.setEmployees(prev => [...prev, item]);
    setModal(false); setForm({}); s.showToast('Карточка сохранена');
  };

  const del = id => { s.setEmployees(p => p.filter(e => e.id !== id)); s.showToast('Удалено'); };

  const filtered = s.employees.filter(e =>
    !search || e.fio?.toLowerCase().includes(search.toLowerCase()) ||
    posName(e.positionId)?.toLowerCase().includes(search.toLowerCase())
  );

  // Departments belonging to selected RES
  const resDepts = form.resUnitId ? s.departments.filter(d => d.resUnitId === form.resUnitId) : [];
  // RES belonging to selected enterprise
  const entResUnits = form.enterpriseId ? s.resUnits.filter(r => r.enterpriseId === form.enterpriseId) : [];

  // All SIZ items for matrix view
  const allSiz = s.sizItems;

  return <div>
    <div className="page-top"><div><h1>Карточки персонала</h1><div className="sub">Реестр сотрудников и выданных СИЗ</div></div>
      <div style={{display:'flex',gap:8}}>
        <button className={`btn ${viewMode==='table'?'btn-p':'btn-o'} btn-sm`} onClick={()=>setViewMode('table')}>Таблица</button>
        <button className={`btn ${viewMode==='matrix'?'btn-p':'btn-o'} btn-sm`} onClick={()=>setViewMode('matrix')}>Матрица СИЗ</button>
        <button className="btn btn-p" onClick={()=>{setForm({});setModal(true)}}><IC.plus style={{width:16,height:16}}/> Создать карточку</button>
      </div>
    </div>

    <div className="card" style={{marginBottom:16}}><div className="card-body" style={{padding:'12px 20px'}}>
      <SearchInput value={search} onChange={setSearch} placeholder="Поиск по ФИО или должности..."/>
    </div></div>

    {viewMode === 'table' && <div className="card"><div className="card-body np"><div className="tbl-wrap"><table><thead><tr>
      <th>ФИО</th><th>Предприятие</th><th>РЭС/Служба</th><th>Подразделение</th><th>Должность</th><th>Размер одежды</th><th>Размер обуви</th><th style={{width:100}}>Действия</th>
    </tr></thead>
    <tbody>{filtered.length ? filtered.map(e => <tr key={e.id}>
      <td><span style={{fontWeight:700,cursor:'pointer',color:'var(--blue)'}} onClick={()=>navigate(`/employee/${e.id}`)}>{e.fio}</span></td>
      <td>{entName(e.enterpriseId)}</td><td>{resName(e.resUnitId)}</td><td>{deptName(e.departmentId)}</td>
      <td><span className="badge b-blue">{posName(e.positionId)}</span></td>
      <td style={{fontSize:12,fontFamily:'JetBrains Mono'}}>{e.clothingSize||'—'}</td>
      <td style={{fontSize:12,fontFamily:'JetBrains Mono'}}>{e.shoeSize||'—'}</td>
      <td><div style={{display:'flex',gap:4}}>
        <button className="btn-icon" onClick={()=>navigate(`/employee/${e.id}`)} title="Просмотр"><IC.eye style={{width:14,height:14}}/></button>
        <button className="btn-icon" onClick={()=>{setForm(e);setModal(true)}}><IC.edit style={{width:14,height:14}}/></button>
        <button className="btn-icon" onClick={()=>del(e.id)}><IC.trash style={{width:14,height:14,color:'var(--red)'}}/></button>
      </div></td>
    </tr>) : <tr><td colSpan="8"><Empty icon={IC.users} text="Нет сотрудников"/></td></tr>}</tbody>
    </table></div></div></div>}

    {viewMode === 'matrix' && <MatrixView employees={filtered} navigate={navigate}/>}

    <Modal open={modal} onClose={()=>setModal(false)} title={form.id ? 'Редактировать карточку' : 'Новая карточка'} wide
      footer={<><button className="btn btn-o" onClick={()=>setModal(false)}>Отмена</button><button className="btn btn-p" onClick={save}>Сохранить</button></>}>
      <div className="fr">
        <div className="fg"><label>1. Организация</label><input className="fc" value={s.org.name} disabled/></div>
        <div className="fg"><label>2. Предприятие</label>
          <select className="fc" value={form.enterpriseId||''} onChange={e=>setForm({...form,enterpriseId:e.target.value,resUnitId:'',departmentId:''})}>
            <option value="">— Выбрать —</option>
            {s.enterprises.map(e=><option key={e.id} value={e.id}>{e.name}</option>)}
          </select>
        </div>
      </div>
      <div className="fr">
        <div className="fg"><label>3. РЭС / Служба</label>
          <select className="fc" value={form.resUnitId||''} onChange={e=>setForm({...form,resUnitId:e.target.value,departmentId:''})}>
            <option value="">— Выбрать —</option>
            {entResUnits.map(r=><option key={r.id} value={r.id}>{r.name}</option>)}
          </select>
        </div>
        <div className="fg"><label>4. Подразделение</label>
          <select className="fc" value={form.departmentId||''} onChange={e=>setForm({...form,departmentId:e.target.value})}>
            <option value="">— Выбрать —</option>
            {resDepts.map(d=><option key={d.id} value={d.id}>{d.name}</option>)}
          </select>
        </div>
      </div>
      <div className="fr">
        <div className="fg" style={{flex:2}}><label>5. ФИО</label><input className="fc" value={form.fio||''} onChange={e=>setForm({...form,fio:e.target.value})} placeholder="Иванов Иван Иванович"/></div>
        <div className="fg"><label>6. Должность</label>
          <select className="fc" value={form.positionId||''} onChange={e=>setForm({...form,positionId:e.target.value})}>
            <option value="">— Выбрать —</option>
            {s.positions.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}
          </select>
        </div>
      </div>
      <div className="fr">
        <div className="fg"><label>7. Размер одежды</label>
          <select className="fc" value={form.clothingSize||''} onChange={e=>setForm({...form,clothingSize:e.target.value})}>
            <option value="">— Выбрать —</option>
            {CLOTHING_SIZES.map(sz=><option key={sz}>{sz}</option>)}
          </select>
        </div>
        <div className="fg"><label>8. Размер обуви</label>
          <select className="fc" value={form.shoeSize||''} onChange={e=>setForm({...form,shoeSize:e.target.value})}>
            <option value="">— Выбрать —</option>
            {SHOE_SIZES.map(sz=><option key={sz}>{sz}</option>)}
          </select>
        </div>
      </div>
    </Modal>
  </div>;
};

// ---- MATRIX VIEW (Personnel + all SIZ columns with green/red) ----
const MatrixView = ({employees, navigate}) => {
  const s = useStore();

  // Group SIZ items by category
  const grouped = CATEGORIES.map(cat => ({
    ...cat,
    items: s.sizItems.filter(i => i.category === cat.key),
  })).filter(g => g.items.length > 0);

  const allItems = grouped.flatMap(g => g.items);

  return <div className="card"><div className="card-body np"><div className="tbl-wrap" style={{maxHeight:'70vh',overflow:'auto'}}>
    <table className="ptbl"><thead>
      <tr>
        <th className="name-col" rowSpan="2" style={{textAlign:'left'}}>ФИО / Должность</th>
        {grouped.map(g => <th key={g.key} colSpan={g.items.length} style={{background:g.key==='clothes'?'#EDE9FE':g.key==='shoes'?'#FEF3C7':g.key==='head'?'#E0E7FF':g.key==='gloves'?'#FCE7F3':'#ECFDF5',textAlign:'center'}}>
          {g.name}
        </th>)}
      </tr>
      <tr>
        {allItems.map(it => <th key={it.id} style={{writingMode:'vertical-lr',transform:'rotate(180deg)',minWidth:30,maxWidth:36,height:120,fontSize:9,padding:'6px 2px',lineHeight:1.2}}>{it.name}</th>)}
      </tr>
    </thead>
    <tbody>
      {employees.length ? employees.map(emp => {
        const empNorms = s.norms.filter(n => n.positionId === emp.positionId);
        const normSizIds = new Set(empNorms.map(n => n.sizItemId));
        const empIssued = s.issued.filter(i => i.employeeId === emp.id && i.status === 'active');
        const issuedMap = {};
        empIssued.forEach(i => { issuedMap[i.sizItemId] = i; });

        return <tr key={emp.id}>
          <td className="name-col" style={{background:'#fff'}}>
            <div style={{cursor:'pointer'}} onClick={()=>navigate(`/employee/${emp.id}`)}>
              <div style={{fontWeight:700,fontSize:12,color:'var(--blue)'}}>{emp.fio}</div>
              <div style={{fontSize:10,color:'var(--tx3)'}}>{s.positions.find(p=>p.id===emp.positionId)?.name||'—'}</div>
            </div>
          </td>
          {allItems.map(it => {
            const isNorm = normSizIds.has(it.id);
            const iss = issuedMap[it.id];
            const expired = iss && iss.expiryDate && isExpired(iss.expiryDate);
            const expSoon = iss && iss.expiryDate && isExpiringSoon(iss.expiryDate);
            let cls = isNorm ? (iss ? (expired ? 'siz-exp' : 'siz-ok') : 'siz-no') : '';
            let text = '';
            if (isNorm) {
              if (iss) {
                text = expired ? '!' : (expSoon ? '~' : '+');
              } else {
                text = '—';
              }
            }
            return <td key={it.id} className={cls} title={isNorm ? (iss ? `Выдано ${fmtDate(iss.issuedDate)}${iss.expiryDate?' до '+fmtDate(iss.expiryDate):''}` : 'Не выдано (положено)') : ''}>
              {text}
            </td>;
          })}
        </tr>;
      }) : <tr><td colSpan={allItems.length+1}><Empty icon={IC.users} text="Нет сотрудников"/></td></tr>}
    </tbody>
    </table>
  </div></div></div>;
};

// ---- EMPLOYEE CARD (detailed view) ----
const EmployeeCard = ({id, navigate}) => {
  const s = useStore();
  const emp = s.employees.find(e => e.id === id);
  const [issueModal, setIssueModal] = useState(false);
  const [issueForm, setIssueForm] = useState({});

  if (!emp) return <div><button className="btn btn-o" onClick={()=>navigate('/employees')}><IC.arrowLeft style={{width:16,height:16}}/> Назад</button><Empty icon={IC.user} text="Сотрудник не найден"/></div>;

  const posName = s.positions.find(p => p.id === emp.positionId)?.name || '—';
  const entName = s.enterprises.find(e => e.id === emp.enterpriseId)?.name || '—';
  const resName = s.resUnits.find(r => r.id === emp.resUnitId)?.name || '—';
  const deptName = s.departments.find(d => d.id === emp.departmentId)?.name || '—';

  const empNorms = s.norms.filter(n => n.positionId === emp.positionId);
  const normSizIds = new Set(empNorms.map(n => n.sizItemId));
  const empIssued = s.issued.filter(i => i.employeeId === emp.id && i.status === 'active');
  const issuedMap = {};
  empIssued.forEach(i => { issuedMap[i.sizItemId] = i; });

  const issueSiz = () => {
    if (!issueForm.sizItemId || !issueForm.issuedDate) return;
    const sizItem = s.sizItems.find(i => i.id === issueForm.sizItemId);
    const expiry = sizItem?.exploitYears ? addYears(issueForm.issuedDate, parseFloat(sizItem.exploitYears)) : '';
    const item = {
      id: uid(),
      employeeId: emp.id,
      sizItemId: issueForm.sizItemId,
      issuedDate: issueForm.issuedDate,
      expiryDate: expiry,
      status: 'active',
    };
    s.setIssued(prev => [...prev, item]);
    setIssueModal(false); setIssueForm({});
    s.showToast('СИЗ выдан');
  };

  const returnSiz = (issuedId) => {
    s.setIssued(prev => prev.map(i => i.id === issuedId ? {...i, status:'returned', returnedDate: new Date().toISOString().split('T')[0]} : i));
    s.showToast('СИЗ возвращён');
  };

  return <div>
    <div className="breadcrumb">
      <span onClick={()=>navigate('/employees')}>Персонал</span> / <span style={{color:'var(--tx1)',cursor:'default'}}>{emp.fio}</span>
    </div>
    <div className="page-top"><div><h1>{emp.fio}</h1><div className="sub">{posName}</div></div>
      <button className="btn btn-p" onClick={()=>setIssueModal(true)}><IC.plus style={{width:16,height:16}}/> Выдать СИЗ</button>
    </div>

    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16,marginBottom:20}}>
      <div className="card"><div className="card-h"><h3>Данные сотрудника</h3></div><div className="card-body">
        {[
          ['Организация', s.org.name],
          ['Предприятие', entName],
          ['РЭС / Служба', resName],
          ['Подразделение', deptName],
          ['Должность', posName],
          ['Размер одежды', emp.clothingSize || '—'],
          ['Размер обуви', emp.shoeSize || '—'],
        ].map(([l,v],i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:'6px 0',borderBottom:i<6?'1px solid var(--border)':'none'}}>
          <span style={{fontSize:12,color:'var(--tx2)',fontWeight:600}}>{l}</span>
          <span style={{fontSize:13,fontWeight:600}}>{v}</span>
        </div>)}
      </div></div>
      <div className="card"><div className="card-h"><h3>Статистика СИЗ</h3></div><div className="card-body">
        <div className="stats" style={{marginBottom:0}}>
          <div className="stat" style={{padding:14}}><div className="stat-ic gr" style={{width:36,height:36}}><IC.check style={{width:18,height:18}}/></div><div><div className="stat-val" style={{fontSize:22}}>{empIssued.length}</div><div className="stat-lbl">Выдано</div></div></div>
          <div className="stat" style={{padding:14}}><div className="stat-ic bl" style={{width:36,height:36}}><IC.scroll style={{width:18,height:18}}/></div><div><div className="stat-val" style={{fontSize:22}}>{empNorms.length}</div><div className="stat-lbl">Положено</div></div></div>
          <div className="stat" style={{padding:14}}><div className="stat-ic rd" style={{width:36,height:36}}><IC.clock style={{width:18,height:18}}/></div><div><div className="stat-val" style={{fontSize:22}}>{empIssued.filter(i=>i.expiryDate&&isExpired(i.expiryDate)).length}</div><div className="stat-lbl">Просрочено</div></div></div>
        </div>
      </div></div>
    </div>

    <div className="card"><div className="card-h"><h3>Все категории СИЗ</h3></div><div className="card-body">
      {CATEGORIES.map(cat => {
        const catSiz = s.sizItems.filter(i => i.category === cat.key);
        if (!catSiz.length) return null;
        const CatIcon = IC[cat.icon];

        return <div key={cat.key} style={{marginBottom:20}}>
          <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:10}}>
            <div className={`cat-icon ${cat.cls}`}><CatIcon style={{width:18,height:18}}/></div>
            <span style={{fontWeight:700,fontSize:14}}>{cat.name}</span>
          </div>
          <div className="ppe-grid">
            {catSiz.map(it => {
              const isNorm = normSizIds.has(it.id);
              const iss = issuedMap[it.id];
              const expired = iss && iss.expiryDate && isExpired(iss.expiryDate);
              const cls = isNorm ? 'assigned' : 'not-assigned';

              return <div key={it.id} className={`ppe-card ${cls}`}>
                <div className="ppe-dot"/>
                <div className="ppe-name">{it.name}</div>
                <div className="ppe-meta">{it.code||'—'} | {it.gender||'—'} | {it.season||'—'}</div>
                {isNorm && <div className="ppe-dates">
                  {iss ? <>
                    <div style={{color:expired?'var(--red)':'var(--green)'}}>Выдано: {fmtDate(iss.issuedDate)}</div>
                    <div style={{color:expired?'var(--red)':'var(--tx2)'}}>Срок до: {fmtDate(iss.expiryDate)}</div>
                    {expired && <span className="badge b-red" style={{marginTop:4}}>ПРОСРОЧЕНО</span>}
                    <button className="btn btn-o btn-sm" style={{marginTop:6,fontSize:11}} onClick={()=>returnSiz(iss.id)}>Вернуть</button>
                  </> : <div style={{color:'var(--red)',fontWeight:600}}>Не выдано</div>}
                </div>}
                {!isNorm && <div className="ppe-meta" style={{marginTop:6,fontStyle:'italic'}}>Не положено</div>}
              </div>;
            })}
          </div>
        </div>;
      })}
    </div></div>

    <Modal open={issueModal} onClose={()=>setIssueModal(false)} title="Выдать СИЗ"
      footer={<><button className="btn btn-o" onClick={()=>setIssueModal(false)}>Отмена</button><button className="btn btn-g" onClick={issueSiz}>Выдать</button></>}>
      <div className="fg"><label>СИЗ (из положенных)</label>
        <select className="fc" value={issueForm.sizItemId||''} onChange={e=>setIssueForm({...issueForm,sizItemId:e.target.value})}>
          <option value="">— Выбрать СИЗ —</option>
          {empNorms.map(n => {
            const it = s.sizItems.find(i => i.id === n.sizItemId);
            if (!it) return null;
            const already = issuedMap[it.id];
            return <option key={n.id} value={it.id} disabled={!!already}>{it.name} ({catByKey(it.category)?.name}) {already?'(уже выдан)':''}</option>;
          })}
        </select>
      </div>
      <div className="fg"><label>Дата выдачи</label><input className="fc" type="date" value={issueForm.issuedDate||''} onChange={e=>setIssueForm({...issueForm,issuedDate:e.target.value})}/></div>
    </Modal>
  </div>;
};

// ═══════════════════════════════════════
// MAIN APP + ROUTING
// ═══════════════════════════════════════
const App = () => {
  const s = useStore();
  const [path, setPath] = useState(window.location.hash.replace('#','') || '/');
  useEffect(() => {
    const h = () => setPath(window.location.hash.replace('#','') || '/');
    window.addEventListener('hashchange', h);
    return () => window.removeEventListener('hashchange', h);
  }, []);
  const navigate = to => { window.location.hash = to; };

  useEffect(() => {
    const el = document.getElementById('loader');
    if (el) { setTimeout(()=>el.classList.add('hide'),600); setTimeout(()=>el.remove(),1100); }
  }, []);

  const empMatch = path.match(/^\/employee\/(.+)$/);
  let content;
  if (path === '/' || path === '') content = <Dashboard/>;
  else if (path === '/org') content = <OrgStructure/>;
  else if (path === '/positions') content = <Positions/>;
  else if (path === '/directories') content = <Directories/>;
  else if (path === '/ton') content = <TonPage/>;
  else if (path === '/employees') content = <EmployeesPage navigate={navigate}/>;
  else if (empMatch) content = <EmployeeCard id={empMatch[1]} navigate={navigate}/>;
  else content = <Dashboard/>;

  const NL = ({to, icon:Icon, children}) => (
    <div className={`sb-link ${path===to?'active':''}`} onClick={()=>navigate(to)}>
      <Icon style={{width:18,height:18}}/>{children}
    </div>
  );

  return <div className="app">
    <aside className="sidebar">
      <div className="sb-logo">
        <div className="sb-logo-icon"><IC.shield style={{width:22,height:22,color:'#fff'}}/></div>
        <div><div className="sb-logo-text">СИЗ</div><div className="sb-logo-sub">Учёт и движение</div></div>
      </div>
      <nav className="sb-nav">
        <div className="sb-section">Основное</div>
        <NL to="/" icon={IC.home}>Панель управления</NL>
        <NL to="/employees" icon={IC.users}>Карточки персонала</NL>

        <div className="sb-section">Справочники</div>
        <NL to="/directories" icon={IC.shield}>Категории СИЗ</NL>
        <NL to="/positions" icon={IC.briefcase}>Должности</NL>
        <NL to="/ton" icon={IC.scroll}>ТОН (Нормы выдачи)</NL>

        <div className="sb-section">Структура</div>
        <NL to="/org" icon={IC.building}>Оргструктура</NL>
      </nav>
      <div className="sb-footer">
        <div style={{fontSize:11,color:'rgba(255,255,255,.25)',textAlign:'center'}}>СИЗ v2.0 — 2026</div>
      </div>
    </aside>
    <main className="main">{content}</main>
    {s.toast && <div className={`toast ${s.toast.type}`}>{s.toast.type==='success' && <IC.check style={{width:16,height:16}}/>}{s.toast.msg}</div>}
  </div>;
};

// ═══════════════════════════════════════
// RENDER
// ═══════════════════════════════════════
ReactDOM.createRoot(document.getElementById('root')).render(<StoreProvider><App/></StoreProvider>);
</script>
</body>
</html>
